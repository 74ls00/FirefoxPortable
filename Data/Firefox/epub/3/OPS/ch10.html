<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Programming Arduino™ Next Steps: Going Further with Sketches</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta>
<link href="stylesheet.css" type="text/css" rel="stylesheet"></link>

<!-- kobo-style -->
<link type="text/css" rel="stylesheet" href="css/kobo.css"></link>
<script type="text/javascript" src="js/kobo.js"></script>
<style type="text/css" id="kobostylehacks">div#book-inner p, div#book-inner div { font-size: 1.0em; } a { color: black; } a:link, a:visited, a:hover, a:active { color: blue; } div#book-inner * { margin-top: 0 !important; margin-bottom: 0 !important;}</style>
</head>
<body><div id="book-columns"><div id="book-inner">
<div class="chapnum" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.1.1">10</span></span></div>
<div class="chaptitle" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.2.1">Serial UART Programming</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="big"><span class="koboSpan" id="kobo.3.1">You should</span></span><span class="koboSpan" id="kobo.4.1"> already be fairly familiar with the serial interface. </span><span class="koboSpan" id="kobo.4.2">You use it when you program your Arduino board, and you also use it to communicate with the Serial Monitor to send data back and forth to the Arduino from your computer. </span><span class="koboSpan" id="kobo.4.3">You do this through the Arduino’s USB-to-serial adapter or directly with the serial adapter. </span><span class="koboSpan" id="kobo.4.4">Interfacing directly is often referred to as </span><i><span class="koboSpan" id="kobo.5.1">TTL Serial</span></i><span class="koboSpan" id="kobo.6.1">, or just </span><i><span class="koboSpan" id="kobo.7.1">Serial</span></i><span class="koboSpan" id="kobo.8.1">. </span><span class="koboSpan" id="kobo.8.2">TTL is a reference to Transistor Transistor Logic, a now redundant technology that used 5V logic levels.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.9.1">Serial communication, of this kind, is not a bus. </span><span class="koboSpan" id="kobo.9.2">It is point-to-point communication. </span><span class="koboSpan" id="kobo.9.3">Only two devices are involved—generally an Arduino and a peripheral.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.10.1">Peripherals that use TTL Serial rather than I2C or SPI tend to be larger devices or devices that have been around for a long time and traditionally always had a TTL Serial interface. </span><span class="koboSpan" id="kobo.10.2">This also includes devices originally intended to be connected to the serial port of a PC. </span><span class="koboSpan" id="kobo.10.3">Examples include GPS modules, multimeters with data logging features, and barcode and RFID readers.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.11.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c10-1" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.12.1">Serial Hardware</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><a href="#fig10-1"><span class="koboSpan" id="kobo.13.1">Figure 10-1</span></a><span class="koboSpan" id="kobo.14.1"> shows the serial hardware for the Arduino Uno.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig10-1" class="image"><span><span class="koboSpan" id="kobo.15.1"><img alt="image" src="images/fig10-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.16.1">Figure 10-1</span></b><span class="koboSpan" id="kobo.17.1">   </span><i><span class="koboSpan" id="kobo.18.1">Arduino Uno serial hardware</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.19.1">The ATmega328 on the Arduino Uno has two pins Rx and Tx (</span><i><span class="koboSpan" id="kobo.20.1">Receive</span></i><span class="koboSpan" id="kobo.21.1"> and </span><i><span class="koboSpan" id="kobo.22.1">Transmit</span></i><span class="koboSpan" id="kobo.23.1">, respectively). </span><span class="koboSpan" id="kobo.23.2">These also double as pins D0 and D1, but if you use them as general I/O pins, you will probably find that you cannot program your Arduino while they are attached to external electronics.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.24.1">These Rx and Tx pins are the serial interface of the hardware Universal Asynchronous Receiver Transmitter (UART) on the ATmega328. </span><span class="koboSpan" id="kobo.24.2">This part of the microcontroller is responsible for sending and receiving bytes of data from and to the microcontroller.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.25.1">The Uno has a separate processor that acts as a USB-to-serial interface. </span><span class="koboSpan" id="kobo.25.2">As well as electrical differences in the serial signal, the USB bus also has a much more complicated protocol than serial and so it does a fair bit of work behind the scenes so it appears the serial port of the ATmega328 is communicating directly with your computer.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.26.1">The Arduino Leonardo does not have a separate chip to act as an USB interface; rather it uses an ATmega chip that includes two UARTs and a built-in USB interface (</span><a href="#fig10-2"><span class="koboSpan" id="kobo.27.1">Figure 10-2</span></a><span class="koboSpan" id="kobo.28.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig10-2" class="image"><span><span class="koboSpan" id="kobo.29.1"><img alt="image" src="images/fig10-2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.30.1">Figure 10-2</span></b><span class="koboSpan" id="kobo.31.1">   </span><i><span class="koboSpan" id="kobo.32.1">Arduino Leonardo serial hardware</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.33.1">One of the UARTs is dedicated to the USB interface and the other is connected to the Rx and Tx pins (D0 and D1). </span><span class="koboSpan" id="kobo.33.2">This gives you the advantage of connecting the Tx and Rx to other electronics and still being able to program the Arduino and send data to the Serial Monitor.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.34.1">Other Arduino boards have differing quantities and arrangements of serial ports. </span><span class="koboSpan" id="kobo.34.2">These are summarized in </span><a href="#tab10-1"><span class="koboSpan" id="kobo.35.1">Table 10-1</span></a><span class="koboSpan" id="kobo.36.1">. </span><span class="koboSpan" id="kobo.36.2">Note that the Due is alone among Arduino boards in operating its serial ports at 3.3V rather than 5V.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="tab10-1" class="imagex"><span><span class="koboSpan" id="kobo.37.1"><img alt="image" src="images/tab10-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.38.1">Table 10-1</span></b><span class="koboSpan" id="kobo.39.1">   </span><i><span class="koboSpan" id="kobo.40.1">UART Serial Interfaces by Arduino Board</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.41.1">TTL Serial has a relatively short range (a few feet or perhaps tens of feet), especially if you use it at a high baud rate. </span><span class="koboSpan" id="kobo.41.2">For communicating over longer distances, an electrical standard called RS232 has been defined. </span><span class="koboSpan" id="kobo.41.3">Until perhaps the last decade, you could commonly find PCs with RS232 serial ports. </span><span class="koboSpan" id="kobo.41.4">The RS232 standard changes the signal levels, making them more suitable for traveling a greater distance than with TTL Serial.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.42.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c10-2" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.43.1">Serial Protocol</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.44.1">The Serial protocol and much of the terminology around it dates back to the early days of computer networking. </span><span class="koboSpan" id="kobo.44.2">Both the sender and receiver have to agree on a speed at which to exchange data. </span><span class="koboSpan" id="kobo.44.3">This speed, called the </span><i><span class="koboSpan" id="kobo.45.1">baud rate</span></i><span class="koboSpan" id="kobo.46.1">, is set at both ends before communication begins. </span><span class="koboSpan" id="kobo.46.2">The baud rate is the number of signal transitions per second, which would be the same as the number of bits per second, were it not for the fact that a byte of data may have start, end, and parity bits. </span><span class="koboSpan" id="kobo.46.3">So, as a rough approximation, if you divide the baud rate by 10, you’ll know about how many bytes per second you can transfer.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.47.1">Baud rates are selected from a number of standard baud rates. </span><span class="koboSpan" id="kobo.47.2">You may have seen these on the Serial Monitor drop-down list on the Arduino IDE. </span><span class="koboSpan" id="kobo.47.3">The baud rates used by the Arduino software are: 300, 1200, 4800, 9600, 14400, 19200, 28800, 38400, 57600, and 115200 baud.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.48.1">The most commonly used baud rate for the Arduino is probably 9600, which tends to be the default baud rate. </span><span class="koboSpan" id="kobo.48.2">There is no particularly good reason for this as the Arduino communicates reliably at 115200 baud. </span><span class="koboSpan" id="kobo.48.3">For projects that require really fast data transfer, this rate will be used. </span><span class="koboSpan" id="kobo.48.4">Another common rate is 2400 baud. </span><span class="koboSpan" id="kobo.48.5">Some peripherals such as Bluetooth serial adaptors and GPS hardware use this rate.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.49.1">Another rather confusing Serial connection parameter that you might encounter is a string of characters like this: 8N1. </span><span class="koboSpan" id="kobo.49.2">This string means 8 bits per packet, No parity checking, and 1 stop bit. </span><span class="koboSpan" id="kobo.49.3">Although other combinations are possible, any device that you are likely to encounter will be 8N1.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.50.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c10-3" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.51.1">The Serial Commands</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.52.1">The Serial commands are not contained in a library, so you do not need an </span><b><span class="koboSpan" id="kobo.53.1">include</span></b><span class="koboSpan" id="kobo.54.1"> command in your sketch.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.55.1">Start serial communication using the command </span><b><span class="koboSpan" id="kobo.56.1">Serial.begin</span></b><span class="koboSpan" id="kobo.57.1">, which takes the baud rate parameter:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.58.1"><img alt="image" src="images/p166-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.59.1">This is typically called just once in the </span><b><span class="koboSpan" id="kobo.60.1">setup</span></b><span class="koboSpan" id="kobo.61.1"> function.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.62.1">If you are using a board that has more than one serial port, and if you are using the default port (port 0), you just use the </span><b><span class="koboSpan" id="kobo.63.1">Serial.begin</span></b><span class="koboSpan" id="kobo.64.1"> command. </span><span class="koboSpan" id="kobo.64.2">If you are using one of the other ports, however, then put the number after the word </span><b><span class="koboSpan" id="kobo.65.1">Serial</span></b><span class="koboSpan" id="kobo.66.1">. </span><span class="koboSpan" id="kobo.66.2">For example, to start communication on serial port 3 on an Arduino Due, you would write the following in your sketch:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.67.1"><img alt="image" src="images/p166-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.68.1">Once </span><b><span class="koboSpan" id="kobo.69.1">Serial.begin</span></b><span class="koboSpan" id="kobo.70.1"> has been called, the UART will listen for incoming bytes and automatically store them in a buffer, so even if the processor is busy doing other things, the bytes will not be lost as long as the buffer does not overflow.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.71.1">Your </span><b><span class="koboSpan" id="kobo.72.1">loop</span></b><span class="koboSpan" id="kobo.73.1"> function can check for incoming bytes of data using the </span><b><span class="koboSpan" id="kobo.74.1">Serial.available</span></b><span class="koboSpan" id="kobo.75.1"> function. </span><span class="koboSpan" id="kobo.75.2">This function returns the number of bytes available for reading. </span><span class="koboSpan" id="kobo.75.3">If no bytes are available, then it returns 0. </span><span class="koboSpan" id="kobo.75.4">This equates to “false” in C, so you will often see code like this that tests for available data:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.76.1"><img alt="image" src="images/p167-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.77.1">The </span><b><span class="koboSpan" id="kobo.78.1">read</span></b><span class="koboSpan" id="kobo.79.1"> command takes no arguments and simply reads the next available byte from the buffer.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.80.1">The </span><b><span class="koboSpan" id="kobo.81.1">readBytes</span></b><span class="koboSpan" id="kobo.82.1"> function reads available bytes into a buffer within the sketch, as opposed to the buffer used by the UART. </span><span class="koboSpan" id="kobo.82.2">It takes two arguments: the buffer to fill (this should be a reference to an array of bytes) and the maximum number of bytes to read. </span><span class="koboSpan" id="kobo.82.3">This argument can be useful if you have a project that needs to send variable length strings to the Arduino. </span><span class="koboSpan" id="kobo.82.4">In general, it is better to avoid this, however, and try to make any communication to an Arduino of a fixed length and as simple as possible.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.83.1">The </span><b><span class="koboSpan" id="kobo.84.1">parseInt</span></b><span class="koboSpan" id="kobo.85.1"> and </span><b><span class="koboSpan" id="kobo.86.1">parseFloat</span></b><span class="koboSpan" id="kobo.87.1"> functions can be convenient, as they allow strings sent to the Arduino to be read as numbers into </span><b><span class="koboSpan" id="kobo.88.1">int</span></b><span class="koboSpan" id="kobo.89.1"> and </span><b><span class="koboSpan" id="kobo.90.1">float</span></b><span class="koboSpan" id="kobo.91.1"> variables, respectively.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.92.1"><img alt="image" src="images/p167-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.93.1">Both functions read characters until they run out or reach a space or other nonnumeric character and then turn the string into a numeric value.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.94.1">Before using functions like </span><b><span class="koboSpan" id="kobo.95.1">parseInt</span></b><span class="koboSpan" id="kobo.96.1"> and </span><b><span class="koboSpan" id="kobo.97.1">parseFloat</span></b><span class="koboSpan" id="kobo.98.1">, make sure you understand why you are doing this. </span><span class="koboSpan" id="kobo.98.2">I have seen code that people have written converting an </span><b><span class="koboSpan" id="kobo.99.1">int</span></b><span class="koboSpan" id="kobo.100.1"> into an array of characters, that sends the array of characters to a second Arduino, which then turns the array back into an </span><b><span class="koboSpan" id="kobo.101.1">int</span></b><span class="koboSpan" id="kobo.102.1">. </span><span class="koboSpan" id="kobo.102.2">There are a number of reasons why this is not a good idea:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.103.1">•  It is unnecessary. </span><span class="koboSpan" id="kobo.103.2">Serial communication sends binary just fine. </span><span class="koboSpan" id="kobo.103.3">All that is required is to send the upper and lower bytes of the </span><b><span class="koboSpan" id="kobo.104.1">int</span></b><span class="koboSpan" id="kobo.105.1">, putting them into the upper and lower bytes of a new </span><b><span class="koboSpan" id="kobo.106.1">int</span></b><span class="koboSpan" id="kobo.107.1"> on receipt.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.108.1">•  Converting numbers into strings and vice versa is slow.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.109.1">•  The serial link may be passing six characters of data (including the null terminator) rather than the 2 bytes of an int.</span></span></div>
<div class="indent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.110.1">If the device you are interfacing with is outside of your control and the designer’s protocol uses strings to hold numbers, or has variable length fields of data, then these functions can be useful. </span><span class="koboSpan" id="kobo.110.2">Otherwise, if the protocol is completely under your control, make life easy for yourself and avoid the unnecessary complexity of converting types and variable-length messages of different formats.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.111.1">The examples in the “Serial Examples” section, later in this chapter, also serve as templates for designing your own communication code.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.112.1">Serial has a lot of functions, many of which you’ll never need to use. </span><span class="koboSpan" id="kobo.112.2">The most handy have been covered here. </span><span class="koboSpan" id="kobo.112.3">For the rest, please refer to the Arduino Serial documentation here: </span><a href="http://arduino.cc/en/Reference/Serial"><span class="koboSpan" id="kobo.113.1">http://arduino.cc/en/Reference/Serial</span></a><span class="koboSpan" id="kobo.114.1">.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.115.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c10-4" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.116.1">The SoftwareSerial Library</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.117.1">Sometimes, especially when using an Arduino Uno, having just one serial port is not enough. </span><span class="koboSpan" id="kobo.117.2">The SoftwareSerial library allows you to use almost any pair of pins for serial communication, but with a few limitations:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.118.1">•  You can only receive data from one SoftwareSerial port at a time.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.119.1">•  You may have trouble using it if your sketch uses timer or external interrupts.</span></span></div>
<div class="indent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.120.1">The functions available mirror those of Serial and, in some respects, are better thought out. </span><span class="koboSpan" id="kobo.120.2">SoftwareSerial includes support for serial communication for devices that use inverted signals, such as the MaxSonar rangefinders. </span><span class="koboSpan" id="kobo.120.3">You also create a SoftwareSerial object for each connection, which is cleaner than the standard Arduino approach of putting a number after the word </span><b><span class="koboSpan" id="kobo.121.1">Serial</span></b><span class="koboSpan" id="kobo.122.1">.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><a href="#tab10-2"><span class="koboSpan" id="kobo.123.1">Table 10-2</span></a><span class="koboSpan" id="kobo.124.1"> shows the pin allocations you can use with SoftwareSerial for the Uno and Leonardo boards. </span><span class="koboSpan" id="kobo.124.2">If you are using a bigger board with four hard serial ports, you are unlikely to need SoftwareSerial. </span><span class="koboSpan" id="kobo.124.3">Unless prefixed with an </span><i><span class="koboSpan" id="kobo.125.1">A</span></i><span class="koboSpan" id="kobo.126.1">, the pin numbers refer to digital pins.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="tab10-2" class="imagex"><span><span class="koboSpan" id="kobo.127.1"><img alt="image" src="images/tab10-2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.128.1">Table 10-2</span></b><span class="koboSpan" id="kobo.129.1">   </span><i><span class="koboSpan" id="kobo.130.1">Pin Usage for SoftwareSerial by Arduino Board</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.131.1">When starting a SoftwareSerial connection, specify the Rx and Tx pins as the two parameters when creating a SoftwareSerial object. </span><span class="koboSpan" id="kobo.131.2">Then use </span><b><span class="koboSpan" id="kobo.132.1">begin</span></b><span class="koboSpan" id="kobo.133.1"> with a baud rate as a parameter to start communication:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.134.1"><img alt="image" src="images/p169-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.135.1">You can find full documentation for the SoftwareSerial library here: </span><a href="http://arduino.cc/en/Reference/SoftwareSerial"><span class="koboSpan" id="kobo.136.1">http://arduino.cc/en/Reference/SoftwareSerial</span></a><span class="koboSpan" id="kobo.137.1">.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.138.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c10-5" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.139.1">Serial Examples</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.140.1">This section includes a mix of UART and SoftwareSerial usage examples.</span></span></div>
<div id="c10-6" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.141.1">Computer to Arduino over USB</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.142.1">This first example uses the Serial Monitor to send commands to an Arduino. </span><span class="koboSpan" id="kobo.142.2">The Arduino will also send analog readings from A0 once per second, while, at the same time, looking for single-character incoming messages of </span><i><span class="koboSpan" id="kobo.143.1">g</span></i><span class="koboSpan" id="kobo.144.1"> for “go” or </span><i><span class="koboSpan" id="kobo.145.1">s</span></i><span class="koboSpan" id="kobo.146.1"> for “stop” to control the flow of readings. </span><a href="#fig10-3"><span class="koboSpan" id="kobo.147.1">Figure 10-3</span></a><span class="koboSpan" id="kobo.148.1"> shows the Serial Monitor while this sketch is running.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig10-3" class="image"><span><span class="koboSpan" id="kobo.149.1"><img alt="image" src="images/fig10-3.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.150.1">Figure 10-3</span></b><span class="koboSpan" id="kobo.151.1">   </span><i><span class="koboSpan" id="kobo.152.1">The Serial Monitor communicating with Arduino</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.153.1">In this situation, because the readings from the Arduino are going to be displayed directly in the Serial Monitor window, the readings may as well be sent as text rather than binary.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.154.1">Here is the sketch for this example:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.155.1"><img alt="image" src="images/p170-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.156.1"><img alt="image" src="images/p171-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.157.1">The </span><b><span class="koboSpan" id="kobo.158.1">loop</span></b><span class="koboSpan" id="kobo.159.1"> tests for incoming serial data, and if there is any, it reads one byte as a character. </span><span class="koboSpan" id="kobo.159.2">This byte is then compared to the </span><b><span class="koboSpan" id="kobo.160.1">‘s’</span></b><span class="koboSpan" id="kobo.161.1"> and </span><b><span class="koboSpan" id="kobo.162.1">‘g’</span></b><span class="koboSpan" id="kobo.163.1"> commands and a status variable, </span><b><span class="koboSpan" id="kobo.164.1">‘sendReadings’</span></b><span class="koboSpan" id="kobo.165.1">, is set accordingly.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.166.1">The </span><b><span class="koboSpan" id="kobo.167.1">sendReadings</span></b><span class="koboSpan" id="kobo.168.1"> variable is then used to determine if the reading should be made and then printed. </span><span class="koboSpan" id="kobo.168.2">If the ‘sendReadings’ flag is true, then there is a second delay before the next reading is sent.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.169.1">Using </span><b><span class="koboSpan" id="kobo.170.1">delay</span></b><span class="koboSpan" id="kobo.171.1"> means that </span><b><span class="koboSpan" id="kobo.172.1">sendReadings</span></b><span class="koboSpan" id="kobo.173.1"> can only be changed the next time around the loop. </span><span class="koboSpan" id="kobo.173.2">This is not a problem for this sketch, but in other circumstances you might need a better solution that does not block the loop. </span><span class="koboSpan" id="kobo.173.3">See </span><a href="ch14.html"><span class="koboSpan" id="kobo.174.1">Chapter 14</span></a><span class="koboSpan" id="kobo.175.1"> for more discussion on this kind of thing.</span></span></div>
<div id="c10-7" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.176.1">Arduino to Arduino</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.177.1">This second example illustrates the sending of data from one Arduino Uno to another over a serial connection. </span><span class="koboSpan" id="kobo.177.2">In this case, readings from A1 of one Arduino are transmitted to the second Arduino, which then uses them to control the flashing rate of the built-in “L” LED.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.178.1">The Arduinos are wired together as shown in </span><a href="#fig10-4"><span class="koboSpan" id="kobo.179.1">Figure 10-4</span></a><span class="koboSpan" id="kobo.180.1">.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig10-4" class="image"><span><span class="koboSpan" id="kobo.181.1"><img alt="image" src="images/fig10-4.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.182.1">Figure 10-4</span></b><span class="koboSpan" id="kobo.183.1">   </span><i><span class="koboSpan" id="kobo.184.1">Two Arduino Unos communicating over serial</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.185.1">One Arduino’s Tx should be connected to the Rx of the other and vice-versa. </span><span class="koboSpan" id="kobo.185.2">In this example, both the Arduinos are using the SoftwareSerial library with pin 8 used as Rx and pin 9 as Tx.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.186.1">The GND connections of the two Arduinos need to be connected, as do the 5V pins as you want to use the sending Arduino to power the receiving Arduino. </span><span class="koboSpan" id="kobo.186.2">The sending Arduino has a trimpot (small variable resistor) pushed into pins A0 to A2. </span><span class="koboSpan" id="kobo.186.3">By setting A0 and A2 to be outputs and then setting A2 HIGH, you can vary the voltage at A1 between 0 and 5V by rotating the knob on the trimpot to control the flashing rate of the LED on the other Arduino.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.187.1">The sending Arduino’s sketch is shown here:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.188.1"><img alt="image" src="images/p172-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.189.1"><img alt="image" src="images/p173-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.190.1">To send the 16 bit (</span><b><span class="koboSpan" id="kobo.191.1">int</span></b><span class="koboSpan" id="kobo.192.1">) reading, the reading is split into high and low bytes and each byte is then sent over the serial link using </span><b><span class="koboSpan" id="kobo.193.1">write</span></b><span class="koboSpan" id="kobo.194.1">. </span><span class="koboSpan" id="kobo.194.2">Whereas </span><b><span class="koboSpan" id="kobo.195.1">print</span></b><span class="koboSpan" id="kobo.196.1"> and </span><b><span class="koboSpan" id="kobo.197.1">println</span></b><span class="koboSpan" id="kobo.198.1"> convert their argument into a string of characters, </span><b><span class="koboSpan" id="kobo.199.1">write</span></b><span class="koboSpan" id="kobo.200.1"> sends the byte as binary.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.201.1">Here is the receiving code:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.202.1"><img alt="image" src="images/p173-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.203.1"><img alt="image" src="images/p174-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.204.1">The receiving code must wait until at least 2 bytes are available and then reconstruct the </span><b><span class="koboSpan" id="kobo.205.1">int</span></b><span class="koboSpan" id="kobo.206.1"> reading by pushing the high byte up to the top 8 bits of the </span><b><span class="koboSpan" id="kobo.207.1">int</span></b><span class="koboSpan" id="kobo.208.1"> and then adding the low byte.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.209.1">If you are considering sending more complex data from one Arduino to another, then you might like to look at the EasyTransfer library: </span><a href="http://www.billporter.info/2011/05/30/easytransfer-arduino-library/"><span class="koboSpan" id="kobo.210.1">www.billporter.info/2011/05/30/easytransfer-arduino-library/</span></a><span class="koboSpan" id="kobo.211.1">.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.212.1">Although this example uses wires to connect the Tx for one Arduino to the Rx of another, you could almost accomplish this as easily with wireless connections. </span><span class="koboSpan" id="kobo.212.2">Many wireless modules operate transparently, in other words, as if the serial ports were connected by wires.</span></span></div>
<div id="c10-8" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.213.1">GPS Module</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.214.1">The final serial communication example reads positional information (latitude and longitude) from a Global Positioning System (GPS) module using TTL Serial, which then formats the data and sends it to the Serial Monitor (</span><a href="#fig10-5"><span class="koboSpan" id="kobo.215.1">Figure 10-5</span></a><span class="koboSpan" id="kobo.216.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig10-5" class="image"><span><span class="koboSpan" id="kobo.217.1"><img alt="image" src="images/fig10-5.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.218.1">Figure 10-5</span></b><span class="koboSpan" id="kobo.219.1">   </span><i><span class="koboSpan" id="kobo.220.1">GPS readings on an Arduino</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.221.1">The communication with the GPS module is one way, so only the Tx output of the module needs to be connected to an Rx pin on an Arduino. </span><span class="koboSpan" id="kobo.221.2">The module used is a Sparkfun Venus GPS module (</span><a href="http://www.sparkfun.com/products/11058"><span class="koboSpan" id="kobo.222.1">www.sparkfun.com/products/11058</span></a><span class="koboSpan" id="kobo.223.1">). </span><span class="koboSpan" id="kobo.223.2">Like most GPS modules, it has TTL Serial output and will send out a burst of messages once a second at 9600 baud.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.224.1">The messages conform to a standard called National Marine Electronics Association (NMEA). </span><span class="koboSpan" id="kobo.224.2">Each message is a string of text, ending with the newline character. </span><span class="koboSpan" id="kobo.224.3">The fields of the message are separated by commas. </span><span class="koboSpan" id="kobo.224.4">A typical message is shown here:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.225.1"><img alt="image" src="images/p174-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.226.1">The fields in the example are as follows:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.227.1">•  </span><b><span class="koboSpan" id="kobo.228.1">$GPRMC</span></b><span class="koboSpan" id="kobo.229.1">   The sentence type</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.230.1">•  </span><b><span class="koboSpan" id="kobo.231.1">081019.548</span></b><span class="koboSpan" id="kobo.232.1">   The time (very accurate) and in 24-hour format. </span><span class="koboSpan" id="kobo.232.2">8:10:19.548</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.233.1">•  </span><b><span class="koboSpan" id="kobo.234.1">5342.6316, N</span></b><span class="koboSpan" id="kobo.235.1">   Latitude × 100, that is, 53.426316 degrees North</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.236.1">•  </span><b><span class="koboSpan" id="kobo.237.1">00239.8728,W</span></b><span class="koboSpan" id="kobo.238.1">   Longitude × 100, that is, 0.2398728 degrees West</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.239.1">•  </span><b><span class="koboSpan" id="kobo.240.1">000.0</span></b><span class="koboSpan" id="kobo.241.1">   Speed</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.242.1">•  </span><b><span class="koboSpan" id="kobo.243.1">079.7</span></b><span class="koboSpan" id="kobo.244.1">   Course 79.7 degrees</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.245.1">•  </span><b><span class="koboSpan" id="kobo.246.1">110613</span></b><span class="koboSpan" id="kobo.247.1">   Date 11 June 2013</span></span></div>
<div class="noindent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.248.1">The remaining fields are not relevant to this example.</span></span></div>
<div class="note" xmlns="http://www.w3.org/1999/xhtml"><span><b><i><span class="koboSpan" id="kobo.249.1">NOTE</span></i></b><span class="koboSpan" id="kobo.250.1">   </span><i><span class="koboSpan" id="kobo.251.1">You can find a complete list of the NMEA GPS sentences listed here: </span><a href="http://aprs.gids.nl/nmea/"><span class="koboSpan" id="kobo.252.1">http://aprs.gids.nl/nmea/</span></a></i><span class="koboSpan" id="kobo.253.1">.</span></span></div>
<div class="indent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.254.1">Here is the code for this example:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.255.1"><img alt="image" src="images/p175-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.256.1"><img alt="image" src="images/p176-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.257.1"><img alt="image" src="images/p177-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.258.1">The sentences coming from the GPS module are of differing lengths, but are all less than 80 characters, so the code uses a buffer variable </span><b><span class="koboSpan" id="kobo.259.1">sentence</span></b><span class="koboSpan" id="kobo.260.1"> that is filled with the data until an end-of-line marker is read or the buffer is full.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.261.1">A </span><i><span class="koboSpan" id="kobo.262.1">C</span></i><span class="koboSpan" id="kobo.263.1"> null character is placed on the end of the buffer when the whole sentence has been read. </span><span class="koboSpan" id="kobo.263.2">This is only so that if you wish, you can “print” the sentence to see the raw data.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.264.1">The rest of the sketch is concerned with extracting individual fields and formatting the output to be written to the Serial Monitor. </span><span class="koboSpan" id="kobo.264.2">The </span><b><span class="koboSpan" id="kobo.265.1">getField</span></b><span class="koboSpan" id="kobo.266.1"> function helpfully extracts the text from a field at a particular index.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.267.1">The </span><b><span class="koboSpan" id="kobo.268.1">displayGPS</span></b><span class="koboSpan" id="kobo.269.1"> function first ignores any sentences that are not of the type </span><b><span class="koboSpan" id="kobo.270.1">“$GPRMC”</span></b><span class="koboSpan" id="kobo.271.1"> and then extracts the latitude and longitude and hemisphere fields to be displayed.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.272.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c10-9" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.273.1">Summary</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.274.1">In this chapter, we investigated a few ways to program serial communications between Arduinos, peripherals, and computers.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.275.1">In the next chapter, we’ll turn our attention to an interesting property of the Arduino Leonardo that allows it to emulate USB peripherals such as a keyboard and mouse. </span><span class="koboSpan" id="kobo.275.2">We will also look at other aspects of USB Programming.</span></span></div>
</div></div></body>
</html>