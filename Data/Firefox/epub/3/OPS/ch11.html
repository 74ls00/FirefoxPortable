<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Programming Arduino™ Next Steps: Going Further with Sketches</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta>
<link href="stylesheet.css" type="text/css" rel="stylesheet"></link>

<!-- kobo-style -->
<link type="text/css" rel="stylesheet" href="css/kobo.css"></link>
<script type="text/javascript" src="js/kobo.js"></script>
<style type="text/css" id="kobostylehacks">div#book-inner p, div#book-inner div { font-size: 1.0em; } a { color: black; } a:link, a:visited, a:hover, a:active { color: blue; } div#book-inner * { margin-top: 0 !important; margin-bottom: 0 !important;}</style>
</head>
<body><div id="book-columns"><div id="book-inner">
<div class="chapnum" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.1.1">11</span></span></div>
<div class="chaptitle" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.2.1">USB Programming</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="big"><span class="koboSpan" id="kobo.3.1">This chapter</span></span><span class="koboSpan" id="kobo.4.1"> looks at various aspects of using the Arduino with USB. </span><span class="koboSpan" id="kobo.4.2">This includes the keyboard and mouse emulation features provided by the Arduino Leonardo and also the reverse process of allowing a USB keyboard or mouse to be connected to a suitably equipped Arduino.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.5.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c11-1" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.6.1">Keyboard and Mouse Emulation</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.7.1">Three Arduino boards—the Due, the Leonardo, and the Micro, which is based on the Leonardo—can use their USB port to emulate a keyboard or mouse. </span><span class="koboSpan" id="kobo.7.2">There are also Arduino-compatible boards like the LeoStick from Freetronics (</span><a href="#fig11-1"><span class="koboSpan" id="kobo.8.1">Figure 11-1</span></a><span class="koboSpan" id="kobo.9.1">) that can perform this trick.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig11-1" class="image"><span><span class="koboSpan" id="kobo.10.1"><img alt="image" src="images/fig11-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.11.1">Figure 11-1</span></b><span class="koboSpan" id="kobo.12.1">   </span><i><span class="koboSpan" id="kobo.13.1">The LeoStick</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.14.1">This feature is practically used largely for things like music controllers, giving the Arduino a way to interface with music synthesis and control programs like Ableton Live. </span><span class="koboSpan" id="kobo.14.2">You could, for example, build novel musical instruments with Arduino that use accelerometer readings, interrupted beams of light, or pedal boards to control music software.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.15.1">Some of the sillier applications of these features include pranks where the computer mouse appears to take on a life of its own or the keyboard itself types random letters.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.16.1">The Arduino Due has two USB ports. </span><span class="koboSpan" id="kobo.16.2">Keyboard and mouse emulation takes place on the </span><i><span class="koboSpan" id="kobo.17.1">native USB port</span></i><span class="koboSpan" id="kobo.18.1">, and you normally program the Arduino Due using the </span><i><span class="koboSpan" id="kobo.19.1">programming USB port</span></i><span class="koboSpan" id="kobo.20.1"> (</span><a href="ch01.html#fig1-2"><span class="koboSpan" id="kobo.21.1">Figure 1-2</span></a><span class="koboSpan" id="kobo.22.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig11-2" class="image"><span><span class="koboSpan" id="kobo.23.1"><img alt="image" src="images/fig11-2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.24.1">Figure 11-2</span></b><span class="koboSpan" id="kobo.25.1">   </span><i><span class="koboSpan" id="kobo.26.1">The Arduino Due’s two USB ports</span></i></span></div>
</div>
<div id="c11-2" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.27.1">Keyboard Emulation</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.28.1">The keyboard functions are quite easy to use. </span><span class="koboSpan" id="kobo.28.2">They are part of the core language, so there is no library to include. </span><span class="koboSpan" id="kobo.28.3">To begin keyboard emulation, simply put the following command in your </span><b><span class="koboSpan" id="kobo.29.1">startup</span></b><span class="koboSpan" id="kobo.30.1"> function:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.31.1"><img alt="image" src="images/p180-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.32.1">To have the Arduino “type” something, you can use </span><b><span class="koboSpan" id="kobo.33.1">print</span></b><span class="koboSpan" id="kobo.34.1"> and </span><b><span class="koboSpan" id="kobo.35.1">println</span></b><span class="koboSpan" id="kobo.36.1"> commands and the text will appear wherever the cursor is positioned:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.37.1"><img alt="image" src="images/p181-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.38.1">If you need to use modifier keys, such as typing </span><small><span class="koboSpan" id="kobo.39.1">CTRL-C</span></small><span class="koboSpan" id="kobo.40.1">, then you can use the </span><b><span class="koboSpan" id="kobo.41.1">press</span></b><span class="koboSpan" id="kobo.42.1"> command:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.43.1"><img alt="image" src="images/p181-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.44.1">The </span><b><span class="koboSpan" id="kobo.45.1">press</span></b><span class="koboSpan" id="kobo.46.1"> command takes a single char as its parameter, and in addition to all the normal characters, a number of constants such as </span><b><span class="koboSpan" id="kobo.47.1">KEY_LEFT_CTRL</span></b><span class="koboSpan" id="kobo.48.1"> are defined for you to use. </span><span class="koboSpan" id="kobo.48.2">Once you issue the </span><b><span class="koboSpan" id="kobo.49.1">press</span></b><span class="koboSpan" id="kobo.50.1"> command, it is as if the key is held down until the </span><b><span class="koboSpan" id="kobo.51.1">releaseAll</span></b><span class="koboSpan" id="kobo.52.1"> command is given. </span><span class="koboSpan" id="kobo.52.2">You can find a full list of the special keys here: </span><a href="http://arduino.cc/en/Reference/KeyboardModifiers"><span class="koboSpan" id="kobo.53.1">http://arduino.cc/en/Reference/KeyboardModifiers</span></a><span class="koboSpan" id="kobo.54.1">.</span></span></div>
<div class="note" xmlns="http://www.w3.org/1999/xhtml"><span><b><i><span class="koboSpan" id="kobo.55.1">NOTE</span></i></b><span class="koboSpan" id="kobo.56.1">   </span><i><span class="koboSpan" id="kobo.57.1">When using the keyboard and mouse emulation features, you may encounter difficulty programming the board as it might be trying to type text while you are trying to program it. </span><span class="koboSpan" id="kobo.57.2">The trick is to keep the Reset button depressed and only release it when the “uploading” message appears in the status line of the Arduino IDE</span></i><span class="koboSpan" id="kobo.58.1">.</span></span></div>
<div id="c11-3" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.59.1">Keyboard Emulation Example</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.60.1">The following example automatically types text of your choice (for instance, a password) every time the Arduino is reset:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.61.1"><img alt="image" src="images/p181-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.62.1">This example would be better if an external button triggered the typing; if you are using a Mac, the operating system thinks a new keyboard has been attached when you reset the device, which opens a system dialog that you must dismiss before the text is typed.</span></span></div>
<div id="c11-4" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.63.1">Mouse Emulation</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.64.1">Emulating a mouse follows much the same pattern as emulating a keyboard. </span><span class="koboSpan" id="kobo.64.2">Indeed there is no reason why you cannot use both in the same sketch.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.65.1">The first step is to begin emulation:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.66.1"><img alt="image" src="images/p182-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.67.1">You can then move the mouse using </span><b><span class="koboSpan" id="kobo.68.1">Mouse.move</span></b><span class="koboSpan" id="kobo.69.1">. </span><span class="koboSpan" id="kobo.69.2">The three parameters are the amount to move the x, y, and scroll button in pixels. </span><span class="koboSpan" id="kobo.69.3">These numbers can be positive (right or down) or negative (left and up). </span><span class="koboSpan" id="kobo.69.4">They are relative to the current mouse position, and as there is no way to get the absolute position of the cursor, this emulation just emulates the mouse that moves the cursor, not the cursor itself.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.70.1">You can also click the mouse using the </span><b><span class="koboSpan" id="kobo.71.1">click</span></b><span class="koboSpan" id="kobo.72.1"> command. </span><span class="koboSpan" id="kobo.72.2">With no parameters, this command is a simple left button click. </span><span class="koboSpan" id="kobo.72.3">You can also optionally supply an argument of </span><b><span class="koboSpan" id="kobo.73.1">MOUSE_RIGHT</span></b><span class="koboSpan" id="kobo.74.1"> or </span><b><span class="koboSpan" id="kobo.75.1">MOUSE_MIDDLE</span></b><span class="koboSpan" id="kobo.76.1">.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.77.1">If you want to control the duration of a mouse click, then you can use the </span><b><span class="koboSpan" id="kobo.78.1">Mouse.press</span></b><span class="koboSpan" id="kobo.79.1"> and </span><b><span class="koboSpan" id="kobo.80.1">Mouse.release</span></b><span class="koboSpan" id="kobo.81.1"> commands. </span><b><span class="koboSpan" id="kobo.82.1">Mouse.press</span></b><span class="koboSpan" id="kobo.83.1"> takes the same optional arguments as </span><b><span class="koboSpan" id="kobo.84.1">Mouse.click</span></b><span class="koboSpan" id="kobo.85.1">. </span><span class="koboSpan" id="kobo.85.2">This can be useful if you are, say, making your own mouse from an Arduino and want the button click to be controlled by a switch connected to a digital input on the Arduino. </span><span class="koboSpan" id="kobo.85.3">Doing this would allow you to double- or triple-click.</span></span></div>
<div id="c11-5" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.86.1">Mouse Emulation Example</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.87.1">The following example moves the mouse randomly around your screen. </span><span class="koboSpan" id="kobo.87.2">To stop the program so you can regain control of your computer, either press and hold down the Reset button or just unplug the board.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.88.1"><img alt="image" src="images/p182-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.89.1"><img alt="image" src="images/p183-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.90.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c11-6" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.91.1">USB Host Programming</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.92.1">Whereas the Leonardo, Due, and Micro have the ability to act like a keyboard or mouse, only the Due and the lesser known Arduino Mega ADK have a feature that allows you to connect a USB keyboard or mouse to it so you can use it as an input device. </span><span class="koboSpan" id="kobo.92.2">This feature is called </span><i><span class="koboSpan" id="kobo.93.1">USB Host</span></i><span class="koboSpan" id="kobo.94.1">, and although only the Due supports it directly, there are third-party USB host shields that you can plug into an Arduino Uno or Leonardo that give you USB Host.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.95.1">What is more, if you have a wireless keyboard and mouse (not the Bluetooth variety), it should also work if you plug the USB adaptor into the host shield’s USB socket. </span><span class="koboSpan" id="kobo.95.2">This way you can add wireless remote control to an Arduino.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.96.1">The USB Host facility is not only restricted to a keyboard and mouse; you can use it for many other USB peripherals, such as video game controllers, cameras, and Bluetooth, and to interface with your Android phone.</span></span></div>
<div id="c11-7" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.97.1">USB Host Shield and Library</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.98.1">The USB Host shield and accompanying libraries have been around for a few years and now support a good range of peripherals. </span><span class="koboSpan" id="kobo.98.2">The original shield was developed by Circuits@home (</span><a href="http://www.circuitsathome.com/"><span class="koboSpan" id="kobo.99.1">www.circuitsathome.com/</span></a><span class="koboSpan" id="kobo.100.1">). </span><span class="koboSpan" id="kobo.100.2">Other compatible USB Host shields are now available from Sparkfun, SainSmart, and probably others. </span><a href="#fig11-3"><span class="koboSpan" id="kobo.101.1">Figure 11-3</span></a><span class="koboSpan" id="kobo.102.1"> shows a Sparkfun USB Host shield attached to an Arduino Uno. </span><span class="koboSpan" id="kobo.102.2">Note that at the time of writing, these boards are not compatible with the Arduino Leonardo, or, in fact, anything much more exotic than a Uno. </span><span class="koboSpan" id="kobo.102.3">So check before buying.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig11-3" class="image"><span><span class="koboSpan" id="kobo.103.1"><img alt="image" src="images/fig11-3.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.104.1">Figure 11-3</span></b><span class="koboSpan" id="kobo.105.1">   </span><i><span class="koboSpan" id="kobo.106.1">Sparkfun USB Host shield</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.107.1">This particular board has a handy prototyping area to which you can solder your own extra components. </span><span class="koboSpan" id="kobo.107.2">An alternative to a shield is to use a board such as the Freetronics USBDroid (</span><a href="#fig11-4"><span class="koboSpan" id="kobo.108.1">Figure 11-4</span></a><span class="koboSpan" id="kobo.109.1">). </span><span class="koboSpan" id="kobo.109.2">This board has both a micro USB port for programming the board and a full-size USB socket that you can plug a keyboard or similar into.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig11-4" class="image"><span><span class="koboSpan" id="kobo.110.1"><img alt="image" src="images/fig11-4.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.111.1">Figure 11-4</span></b><span class="koboSpan" id="kobo.112.1">   </span><i><span class="koboSpan" id="kobo.113.1">The Freetronics USBDroid</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.114.1">If you are using the USBDroid or an unofficial USB Host shield, then you need to use the original USB_Host_Shield library from Circuits@ Home. </span><span class="koboSpan" id="kobo.114.2">If you are using the official board, then the USB_Host_Shield_2 library is available with support for more types of devices.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.115.1">USB programming using the Host Shield Libraries is not easy. </span><span class="koboSpan" id="kobo.115.2">The library provides a fairly low-level interface to the USB bus. </span><span class="koboSpan" id="kobo.115.3">The sample sketch </span><b><span class="koboSpan" id="kobo.116.1">sketch_11_03_host_keyboard</span></b><span class="koboSpan" id="kobo.117.1">, available from the author’s web site (</span><a href="http://www.simonmonk.org"><span class="koboSpan" id="kobo.118.1">www.simonmonk.org</span></a><span class="koboSpan" id="kobo.119.1">), is an example of connecting a keyboard using a USB Host connection.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.120.1">This sketch is adapted from one of the example sketches in the examples folder of the USB_Host_Shield library. </span><span class="koboSpan" id="kobo.120.2">The code is changed to output keypresses to the Serial Monitor rather than to an LCD screen as in the original example, however.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.121.1">The sketch (and the original on which it is based) make a useful template for your own code, as they both handle all the keys on the keyboard properly. </span><span class="koboSpan" id="kobo.121.2">If you were only interested in the digit or cursor keys, then you could greatly simplify the sketch.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.122.1">The sketch is too long to list here in full, so instead I will just highlight key areas. </span><span class="koboSpan" id="kobo.122.2">You might find it useful to have the sketch loaded while reading the descriptions of the code.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.123.1">There are three libraries to import:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.124.1"><img alt="image" src="images/p186-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.125.1">The </span><b><span class="koboSpan" id="kobo.126.1">Spi.h</span></b><span class="koboSpan" id="kobo.127.1"> library is required because that is the interface used by the USB Host controller chip. </span><span class="koboSpan" id="kobo.127.2">The chip itself is a </span><b><span class="koboSpan" id="kobo.128.1">Max3421e</span></b><span class="koboSpan" id="kobo.129.1">, hence, that library, and finally there is another library (</span><b><span class="koboSpan" id="kobo.130.1">Usb.h</span></b><span class="koboSpan" id="kobo.131.1">) layered on top of that, which hides some of the complexity of using the chip directly.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.132.1">After importing the libraries, you’ll see a series of constant definitions like this:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.133.1"><img alt="image" src="images/p186-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.134.1">These are just a different way to define constants in C. </span><span class="koboSpan" id="kobo.134.2">It could have also been written like this:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.135.1"><img alt="image" src="images/p186-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.136.1">MAX3421E and USB objects are then created, and in </span><b><span class="koboSpan" id="kobo.137.1">setup</span></b><span class="koboSpan" id="kobo.138.1">, the </span><b><span class="koboSpan" id="kobo.139.1">powerOn</span></b><span class="koboSpan" id="kobo.140.1"> function of </span><b><span class="koboSpan" id="kobo.141.1">Max</span></b><span class="koboSpan" id="kobo.142.1"> is invoked.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.143.1"><img alt="image" src="images/p186-04.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.144.1">In the </span><b><span class="koboSpan" id="kobo.145.1">loop</span></b><span class="koboSpan" id="kobo.146.1"> function, both Max and Usb have their respective </span><b><span class="koboSpan" id="kobo.147.1">Task</span></b><span class="koboSpan" id="kobo.148.1"> functions called. </span><span class="koboSpan" id="kobo.148.2">This triggers the interface to check for USB activity.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.149.1"><img alt="image" src="images/p186-05.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.150.1">The USB interface will on first startup be in the </span><b><span class="koboSpan" id="kobo.151.1">USB_STATE_CONFIGURING</span></b><span class="koboSpan" id="kobo.152.1"> state until the keyboard connection is established when </span><b><span class="koboSpan" id="kobo.153.1">kbd_init</span></b><span class="koboSpan" id="kobo.154.1"> is called. </span><span class="koboSpan" id="kobo.154.2">This function uses an endpoint record structure (</span><b><span class="koboSpan" id="kobo.155.1">ep_record</span></b><span class="koboSpan" id="kobo.156.1">) into which the parts of the message are placed to establish a message to begin the link with the keyboard:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.157.1"><img alt="image" src="images/p187-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.158.1">After initialization is complete, the most likely state encountered in the main loop is that the keyboard is up and running (</span><b><span class="koboSpan" id="kobo.159.1">USB_STATE_RUNNING</span></b><span class="koboSpan" id="kobo.160.1">), in which case </span><b><span class="koboSpan" id="kobo.161.1">kbd_poll</span></b><span class="koboSpan" id="kobo.162.1"> is called to check for a keypress on the keyboard.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.163.1">The key line in </span><b><span class="koboSpan" id="kobo.164.1">kbd_poll</span></b><span class="koboSpan" id="kobo.165.1"> is</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.166.1"><img alt="image" src="images/p187-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.167.1">This line reads a USB key scancode to see if a key has been pressed. </span><span class="koboSpan" id="kobo.167.2">This code is not the same as an ASCII value. </span><span class="koboSpan" id="kobo.167.3">The mapping to ASCII takes place in the </span><b><span class="koboSpan" id="kobo.168.1">HIDtoA</span></b><span class="koboSpan" id="kobo.169.1"> function. </span><span class="koboSpan" id="kobo.169.2">This function is the most complex in the sketch, but one that you can easily reuse in your own sketches. </span><span class="koboSpan" id="kobo.169.3">You can find a list of scancodes and how they map to ASCII here: </span><a href="http://www.win.tue.nl/~aeb/linux/kbd/scancodes-1.html"><span class="koboSpan" id="kobo.170.1">www.win.tue.nl/~aeb/linux/kbd/scancodes-1.html</span></a><span class="koboSpan" id="kobo.171.1">.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.172.1">One interesting feature of the USB Human Interface Device (HID) protocol used with keyboards is that the </span><small><span class="koboSpan" id="kobo.173.1">SCROLL LOCK</span></small><span class="koboSpan" id="kobo.174.1"> and </span><small><span class="koboSpan" id="kobo.175.1">NUM LOCK</span></small><span class="koboSpan" id="kobo.176.1"> indicator LEDs can be controlled. </span><span class="koboSpan" id="kobo.176.2">This takes place in the </span><b><span class="koboSpan" id="kobo.177.1">kbd_poll</span></b><span class="koboSpan" id="kobo.178.1"> function in response to the </span><small><span class="koboSpan" id="kobo.179.1">SCROLL LOCK</span></small><span class="koboSpan" id="kobo.180.1">, </span><small><span class="koboSpan" id="kobo.181.1">CAPS LOCK</span></small><span class="koboSpan" id="kobo.182.1">, and </span><small><span class="koboSpan" id="kobo.183.1">NUM LOCK</span></small><span class="koboSpan" id="kobo.184.1"> keys being pressed, however, you could write a little sketch like the one in </span><b><span class="koboSpan" id="kobo.185.1">sketch_11_04_host_scroll_lock</span></b><span class="koboSpan" id="kobo.186.1"> that simply flashes the LEDs.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.187.1">The key function in this sketch is</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.188.1"><img alt="image" src="images/p187-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.189.1"><img alt="image" src="images/p188-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.190.1">The three least significant bits of the character are flags for the three “lock” LEDs on the keyboard.</span></span></div>
<div id="c11-8" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.191.1">USB Host on the Arduino Due</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.192.1">The Arduino Due hast the ability to act as a built-in USB Host. </span><span class="koboSpan" id="kobo.192.2">This feature is, at the time of writing, considered to be “experimental” by the Arduino team. </span><span class="koboSpan" id="kobo.192.3">Check the official Arduino documentation (</span><a href="http://arduino.cc/en/Reference/USBHost"><span class="koboSpan" id="kobo.193.1">http://arduino.cc/en/Reference/USBHost</span></a><span class="koboSpan" id="kobo.194.1">) for changes to the status of this work or any changes to the way it is used.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.195.1">The Due does not have a full-size USB socket into which you can directly plug a USB keyboard or mouse. </span><span class="koboSpan" id="kobo.195.2">To use such devices, you must get a Micro USB OTG Host Cable like the one attached to the Due pictured in </span><a href="#fig11-5"><span class="koboSpan" id="kobo.196.1">Figure 11-5</span></a><span class="koboSpan" id="kobo.197.1">. </span><span class="koboSpan" id="kobo.197.2">In the figure, the USB adapter for a wireless keyboard is attached to the Arduino Due, but a regular USB keyboard would work just fine.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig11-5" class="image"><span><span class="koboSpan" id="kobo.198.1"><img alt="image" src="images/fig11-5.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.199.1">Figure 11-5</span></b><span class="koboSpan" id="kobo.200.1">   </span><i><span class="koboSpan" id="kobo.201.1">Arduino Due with a Micro USB OTG Host Cable and keyboard</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.202.1">The USB libraries on the Arduino Due are actually a great deal easier to use than the USB Host library and will return the ASCII value of a key that is pressed and not just the USB key scancode. </span><span class="koboSpan" id="kobo.202.2">The following example illustrates interfacing to a keyboard. </span><span class="koboSpan" id="kobo.202.3">It simply echoes each keypress in the Serial Monitor.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.203.1"><img alt="image" src="images/p189-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.204.1">The </span><b><span class="koboSpan" id="kobo.205.1">KeyboardController</span></b><span class="koboSpan" id="kobo.206.1"> library invokes the </span><b><span class="koboSpan" id="kobo.207.1">keyPressed</span></b><span class="koboSpan" id="kobo.208.1"> function in the sketch every time a key is pressed. </span><span class="koboSpan" id="kobo.208.2">You can also intercept key release using the </span><b><span class="koboSpan" id="kobo.209.1">keyReleased</span></b><span class="koboSpan" id="kobo.210.1"> function. </span><span class="koboSpan" id="kobo.210.2">To find out which key was pressed, you must call one of the following functions on the </span><b><span class="koboSpan" id="kobo.211.1">keyboard</span></b><span class="koboSpan" id="kobo.212.1"> object:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.213.1">•  </span><b><span class="koboSpan" id="kobo.214.1">getModifiers</span></b><span class="koboSpan" id="kobo.215.1">   Returns a bit mask for any modifier key that is depressed (</span><small><span class="koboSpan" id="kobo.216.1">SHIFT</span></small><span class="koboSpan" id="kobo.217.1">, </span><small><span class="koboSpan" id="kobo.218.1">CTRL</span></small><span class="koboSpan" id="kobo.219.1">, and so on). </span><span class="koboSpan" id="kobo.219.2">See </span><a href="http://arduino.cc/en/Reference/GetModifiers"><span class="koboSpan" id="kobo.220.1">http://arduino.cc/en/Reference/GetModifiers</span></a><span class="koboSpan" id="kobo.221.1"> for the codes.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.222.1">•  </span><b><span class="koboSpan" id="kobo.223.1">getKey</span></b><span class="koboSpan" id="kobo.224.1">   Gets the current key as an ASCII value.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.225.1">•  </span><b><span class="koboSpan" id="kobo.226.1">getOemKey</span></b><span class="koboSpan" id="kobo.227.1">   Returns the key scancode.</span></span></div>
<div class="indent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.228.1">Using a mouse is equally easy and follows a similar pattern to the keyboard controller. </span><span class="koboSpan" id="kobo.228.2">The following example writes a letter—</span><i><span class="koboSpan" id="kobo.229.1">L, R, U</span></i><span class="koboSpan" id="kobo.230.1">, or D—depending on whether the mouse is moved left, right, up, or down:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.231.1"><img alt="image" src="images/p190-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.232.1">As well as the </span><b><span class="koboSpan" id="kobo.233.1">mouseMoved</span></b><span class="koboSpan" id="kobo.234.1"> function, you can also add the following functions to intercept other mouse events:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.235.1">•  </span><b><span class="koboSpan" id="kobo.236.1">mouseDragged</span></b><span class="koboSpan" id="kobo.237.1">   This event is triggered when moving the mouse while holding down the left button.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.238.1">•  </span><b><span class="koboSpan" id="kobo.239.1">mousePressed</span></b><span class="koboSpan" id="kobo.240.1">   This event is triggered when a mouse button is pressed and should be followed by a call to </span><b><span class="koboSpan" id="kobo.241.1">mouse.getButton</span></b><span class="koboSpan" id="kobo.242.1">, which takes a button name of LEFT_BUTTON, RIGHT_BUTTON, or MIDDLE_BUTTON as an argument and returns true if it has been pressed.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.243.1">•  </span><b><span class="koboSpan" id="kobo.244.1">mouseReleased</span></b><span class="koboSpan" id="kobo.245.1">   This function is the counterpart to </span><b><span class="koboSpan" id="kobo.246.1">mousePressed</span></b><span class="koboSpan" id="kobo.247.1"> and is used to detect when the mouse has been released.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.248.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c11-9" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.249.1">Summary</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.250.1">In this chapter, you looked at a few ways to use an Arduino with USB devices.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.251.1">In the next chapter, we will look at using wired and wireless network connections with an Arduino and learn how to do some network programming as well as make use of the Ethernet and WiFi Arduino shields.</span></span></div>
</div></div></body>
</html>