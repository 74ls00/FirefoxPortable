<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Programming Arduino™ Next Steps: Going Further with Sketches</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta>
<link href="stylesheet.css" type="text/css" rel="stylesheet"></link>

<!-- kobo-style -->
<link type="text/css" rel="stylesheet" href="css/kobo.css"></link>
<script type="text/javascript" src="js/kobo.js"></script>
<style type="text/css" id="kobostylehacks">div#book-inner p, div#book-inner div { font-size: 1.0em; } a { color: black; } a:link, a:visited, a:hover, a:active { color: blue; } div#book-inner * { margin-top: 0 !important; margin-bottom: 0 !important;}</style>
</head>
<body><div id="book-columns"><div id="book-inner">
<div class="chapnum" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.1.1">12</span></span></div>
<div class="chaptitle" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.2.1">Network Programming</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="big"><span class="koboSpan" id="kobo.3.1">The Internet</span></span><span class="koboSpan" id="kobo.4.1">, in what has been called the </span><i><span class="koboSpan" id="kobo.5.1">Internet of Things</span></i><span class="koboSpan" id="kobo.6.1">, is starting to go beyond browsers and web servers to include Internet-enabled hardware. </span><span class="koboSpan" id="kobo.6.2">Printers, home automation devices, and even refrigerators are not only becoming smart, but also being connected to the Internet. </span><span class="koboSpan" id="kobo.6.3">And Arduino is at the forefront of DIY Internet devices using either a wired connection to an Ethernet Shield or a WiFi connection. </span><span class="koboSpan" id="kobo.6.4">In this chapter, we look at how to program the Arduino to make use of a network connection.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.7.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-1" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.8.1">Networking Hardware</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.9.1">You have a number of choices for connecting your Arduino to the network. </span><span class="koboSpan" id="kobo.9.2">You can use an Ethernet Shield with an Arduino Uno or an Arduino with built-in Ethernet hardware, or go for the more expensive, but wireless, WiFi Shield.</span></span></div>
<div id="c12-2" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.10.1">Ethernet Shield</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.11.1">As well as providing an Ethernet connection, the Ethernet Shield (</span><a href="#fig12-1"><span class="koboSpan" id="kobo.12.1">Figure 12-1</span></a><span class="koboSpan" id="kobo.13.1">) also provides a microSD card slot, which you can use to store data (see “Using SD Card Storage” in </span><a href="ch06.html"><span class="koboSpan" id="kobo.14.1">Chapter 6</span></a><span class="koboSpan" id="kobo.15.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig12-1" class="image"><span><span class="koboSpan" id="kobo.16.1"><img alt="image" src="images/fig12-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.17.1">Figure 12-1</span></b><span class="koboSpan" id="kobo.18.1">   </span><i><span class="koboSpan" id="kobo.19.1">Ethernet Shield</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.20.1">The W5100 chip is used in the official boards; you can also find much lower-cost Ethernet Shields that use the ENC28J60 chipset. </span><span class="koboSpan" id="kobo.20.2">These less expensive boards are not compatible with the Ethernet library, however, and are frankly best avoided unless you have more time than budget.</span></span></div>
<div id="c12-3" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.21.1">Arduino Ethernet/EtherTen</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.22.1">An alternative to using a separate shield is to buy an Arduino with built-in Ethernet capability. </span><span class="koboSpan" id="kobo.22.2">The official version is the Arduino Ethernet, but a worthy and Uno-compatible third-party board is the EtherTen produced by Freetronics (</span><a href="http://www.freetronics.com"><span class="koboSpan" id="kobo.23.1">www.freetronics.com</span></a><span class="koboSpan" id="kobo.24.1">). </span><span class="koboSpan" id="kobo.24.2">This board is shown in </span><a href="#fig12-2"><span class="koboSpan" id="kobo.25.1">Figure 12-2</span></a><span class="koboSpan" id="kobo.26.1">.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig12-2" class="image"><span><span class="koboSpan" id="kobo.27.1"><img alt="image" src="images/fig12-2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.28.1">Figure 12-2</span></b><span class="koboSpan" id="kobo.29.1">   </span><i><span class="koboSpan" id="kobo.30.1">An EtherTen board</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.31.1">Combining everything onto one board makes a lot of sense when building a networked Arduino project. </span><span class="koboSpan" id="kobo.31.2">The Arduino Ethernet can also be fitted with a Power over Ethernet (PoE) adapter that, with a separate PoE injector, allows the board to be powered from an Ethernet lead, reducing the wires needed for the Arduino to be just a single Ethernet lead. </span><span class="koboSpan" id="kobo.31.3">The EtherTen board comes already configured to use PoE. </span><span class="koboSpan" id="kobo.31.4">For more information on using PoE with an EtherTen, see </span><a href="http://www.doctormonk.com/2012/01/power-over-ethernet-poe.html"><span class="koboSpan" id="kobo.32.1">www.doctormonk.com/2012/01/power-over-ethernet-poe.html</span></a><span class="koboSpan" id="kobo.33.1">.</span></span></div>
<div id="c12-4" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.34.1">Arduino and WiFi</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.35.1">The problem with an Ethernet Internet connection is, of course, that it requires a wire. </span><span class="koboSpan" id="kobo.35.2">If you want your Arduino to connect to the Internet or to a network and operate wirelessly, then you need a WiFi Shield (</span><a href="#fig12-3"><span class="koboSpan" id="kobo.36.1">Figure 12-3</span></a><span class="koboSpan" id="kobo.37.1">). </span><span class="koboSpan" id="kobo.37.2">These are somewhat expensive, but third-party alternatives are available such as the Sparkfun WiFly shield (</span><a href="https://www.sparkfun.com/products/9954"><span class="koboSpan" id="kobo.38.1">https://www.sparkfun.com/products/9954</span></a><span class="koboSpan" id="kobo.39.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig12-3" class="image"><span><span class="koboSpan" id="kobo.40.1"><img alt="image" src="images/fig12-3.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.41.1">Figure 12-3</span></b><span class="koboSpan" id="kobo.42.1">   </span><i><span class="koboSpan" id="kobo.43.1">An Arduino WiFi Shield</span></i></span></div>
</div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.44.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-5" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.45.1">The Ethernet Library</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.46.1">The Ethernet library has undergone a major revision since the release of Arduino 1.0 in 2011. </span><span class="koboSpan" id="kobo.46.2">In addition to allowing an Ethernet-equipped Arduino to act as either a web server or a web client (sending requests like a browser), the library also handles things like Dynamic Host Configuration Protocol (DHCP), which automatically assigns an IP address to the Arduino.</span></span></div>
<div class="note" xmlns="http://www.w3.org/1999/xhtml"><span><b><i><span class="koboSpan" id="kobo.47.1">NOTE</span></i></b><span class="koboSpan" id="kobo.48.1">   </span><i><span class="koboSpan" id="kobo.49.1">The official Arduino documentation on the Ethernet library is actually very good: </span><a href="http://arduino.cc/en/reference/ethernet"><span class="koboSpan" id="kobo.50.1">http://arduino.cc/en/reference/ethernet</span></a></i><span class="koboSpan" id="kobo.51.1">.</span></span></div>
<div id="c12-6" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.52.1">Making a Connection</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.53.1">The first step, before any communication can take place, is to establish a connection from the Arduino to your network. </span><span class="koboSpan" id="kobo.53.2">The library function is called </span><b><span class="koboSpan" id="kobo.54.1">Ethernet.begin()</span></b><span class="koboSpan" id="kobo.55.1">. </span><span class="koboSpan" id="kobo.55.2">You can manually specify the connection settings for the board using the following syntax:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.56.1"><img alt="image" src="images/p196-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.57.1">Let’s look at each of these parameters in turn:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.58.1">•  </span><b><span class="koboSpan" id="kobo.59.1">mac</span></b><span class="koboSpan" id="kobo.60.1">   The mac address of the network card (I’ll explain this in a moment.)</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.61.1">•  </span><b><span class="koboSpan" id="kobo.62.1">ip</span></b><span class="koboSpan" id="kobo.63.1">   The IP address of the board (You have to select one acceptable to your network.)</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.64.1">•  </span><b><span class="koboSpan" id="kobo.65.1">dns</span></b><span class="koboSpan" id="kobo.66.1">   The IP address for a Domain Name Server (DNS)</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.67.1">•  </span><b><span class="koboSpan" id="kobo.68.1">gateway</span></b><span class="koboSpan" id="kobo.69.1">   The IP address for the Internet gateway (your home hub)</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.70.1">•  </span><b><span class="koboSpan" id="kobo.71.1">subnet</span></b><span class="koboSpan" id="kobo.72.1">   The subnet mask</span></span></div>
<div class="indent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.73.1">This syntax looks a little daunting unless you are used to manual network administration. </span><span class="koboSpan" id="kobo.73.2">Fortunately, all the parameters except </span><b><span class="koboSpan" id="kobo.74.1">mac</span></b><span class="koboSpan" id="kobo.75.1"> are optional, and 90 percent of the time, you will either specify </span><b><span class="koboSpan" id="kobo.76.1">mac</span></b><span class="koboSpan" id="kobo.77.1"> and </span><b><span class="koboSpan" id="kobo.78.1">ip</span></b><span class="koboSpan" id="kobo.79.1"> or, most likely, just the </span><b><span class="koboSpan" id="kobo.80.1">mac</span></b><span class="koboSpan" id="kobo.81.1"> on its own. </span><span class="koboSpan" id="kobo.81.2">All the other settings are taken care of automatically.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.82.1">The MAC, or Media Access Control, address is a unique identifier for the network interface; in other words, it’s the address for the Ethernet Shield or for whatever is providing the network interface for the Arduino. </span><span class="koboSpan" id="kobo.82.2">This strange-looking code only has to be unique for your network. </span><span class="koboSpan" id="kobo.82.3">You’ll usually find this number printed on the back of your Arduino Ethernet Shield or WiFi Shield (</span><a href="#fig12-4"><span class="koboSpan" id="kobo.83.1">Figure 12-4</span></a><span class="koboSpan" id="kobo.84.1">) or on the box packaging. </span><span class="koboSpan" id="kobo.84.2">If you are using an older board that does not have a MAC address, then you can simply make one up. </span><span class="koboSpan" id="kobo.84.3">However, do not use the same made-up number more than once on your network.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig12-4" class="image"><span><span class="koboSpan" id="kobo.85.1"><img alt="image" src="images/fig12-4.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.86.1">Figure 12-4</span></b><span class="koboSpan" id="kobo.87.1">   </span><i><span class="koboSpan" id="kobo.88.1">Mac address sticker on a WiFi Shield</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.89.1">You can also create a network connection using DHCP so the IP address is allocated dynamically; use this code:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.90.1"><img alt="image" src="images/p197-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.91.1">If you want to fix the IP address, which would be desirable if you wanted to run a web server on the Arduino, then you would use code like this:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.92.1"><img alt="image" src="images/p198-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.93.1">You need to ensure that the IP address you use is acceptable to your network. </span><span class="koboSpan" id="kobo.93.2">If you do not specify an IP address and use DHCP, then </span><b><span class="koboSpan" id="kobo.94.1">Ethernet.begin</span></b><span class="koboSpan" id="kobo.95.1"> will return 1 if a connection is made and an IP address allocated; otherwise, it returns a 0. </span><span class="koboSpan" id="kobo.95.2">You can incorporate a test in which you make the connection and use the </span><b><span class="koboSpan" id="kobo.96.1">localIP</span></b><span class="koboSpan" id="kobo.97.1"> function to retrieve the IP address allocated to the Arduino. </span><span class="koboSpan" id="kobo.97.2">The following example performs this test and reports the status to the Serial Monitor. </span><span class="koboSpan" id="kobo.97.3">This is a full sketch that you can try for yourself. </span><span class="koboSpan" id="kobo.97.4">But before you do, remember to change the MAC address in the code to match that of your interface board.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.98.1"><img alt="image" src="images/p198-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.99.1"><img alt="image" src="images/p199-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-7" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.100.1">Setting Up a Web Server</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.101.1">The project “Physical Web Server,” described later in this chapter, illustrates the code structure of a web server sketch. </span><span class="koboSpan" id="kobo.101.2">In this section, we’ll look at the available web server functions.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.102.1">The </span><b><span class="koboSpan" id="kobo.103.1">EthernetServer</span></b><span class="koboSpan" id="kobo.104.1"> class contains most of the functions that you need for web serving. </span><span class="koboSpan" id="kobo.104.2">Having established a connection to the network, starting a web server requires two further steps. </span><span class="koboSpan" id="kobo.104.3">First, you need to create a new server object, specifying the port that the server should be listening on. </span><span class="koboSpan" id="kobo.104.4">This declaration appears in the sketch before the </span><b><span class="koboSpan" id="kobo.105.1">setup</span></b><span class="koboSpan" id="kobo.106.1"> function.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.107.1"><img alt="image" src="images/p199-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.108.1">Web pages are usually served on port 80. </span><span class="koboSpan" id="kobo.108.2">So if you start the web server on port 80, you will not need to add a port number to any URL that connects to the server.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.109.1">Second, to actually start the server, you use the following command in your </span><b><span class="koboSpan" id="kobo.110.1">setup</span></b><span class="koboSpan" id="kobo.111.1"> function:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.112.1"><img alt="image" src="images/p199-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.113.1">This function starts the server, and it will now be waiting for someone with a browser to load the web page that it is serving. </span><span class="koboSpan" id="kobo.113.2">This action is detected in the </span><b><span class="koboSpan" id="kobo.114.1">loop</span></b><span class="koboSpan" id="kobo.115.1"> function of your sketch using the </span><b><span class="koboSpan" id="kobo.116.1">available</span></b><span class="koboSpan" id="kobo.117.1"> function. </span><span class="koboSpan" id="kobo.117.2">This function returns either null (if there are no requests to service) or an </span><b><span class="koboSpan" id="kobo.118.1">EthernetClient</span></b><span class="koboSpan" id="kobo.119.1"> object. </span><span class="koboSpan" id="kobo.119.2">This object is rather confusingly also used when making outgoing requests from the Arduino to web servers. </span><span class="koboSpan" id="kobo.119.3">In either case, </span><b><span class="koboSpan" id="kobo.120.1">EthernetClient</span></b><span class="koboSpan" id="kobo.121.1"> represents the connection between a web server and a browser.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.122.1">Having retrieved this object, you can then read the incoming request using </span><b><span class="koboSpan" id="kobo.123.1">read</span></b><span class="koboSpan" id="kobo.124.1"> and you can write HTML to it using the </span><b><span class="koboSpan" id="kobo.125.1">write</span></b><span class="koboSpan" id="kobo.126.1">, </span><b><span class="koboSpan" id="kobo.127.1">print</span></b><span class="koboSpan" id="kobo.128.1">, and </span><b><span class="koboSpan" id="kobo.129.1">println</span></b><span class="koboSpan" id="kobo.130.1"> functions. </span><span class="koboSpan" id="kobo.130.2">Once you’ve finished writing the HTML to the client, you need to call stop on the client object to end the session. </span><span class="koboSpan" id="kobo.130.3">I explain how to do this in “Physical Web Server” later in this chapter.</span></span></div>
<div id="c12-8" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.131.1">Making Requests</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.132.1">In addition to having the Arduino act as a web server, you can also have it act like a web browser, issuing HTTP requests to a remote web server, which may be on your own network or on the Internet.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.133.1">When making web requests from the Arduino, you first establish a network connection in just the same way that you did in the previous section for the web server, but instead of creating an </span><b><span class="koboSpan" id="kobo.134.1">EthernetServer</span></b><span class="koboSpan" id="kobo.135.1"> object, you create an </span><b><span class="koboSpan" id="kobo.136.1">EthernetClient</span></b><span class="koboSpan" id="kobo.137.1"> object:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.138.1"><img alt="image" src="images/p200-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.139.1">You do not need to do anything more with the client object until you want to send a web request. </span><span class="koboSpan" id="kobo.139.2">Then you write something like this:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.140.1"><img alt="image" src="images/p200-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.141.1">The </span><b><span class="koboSpan" id="kobo.142.1">connect</span></b><span class="koboSpan" id="kobo.143.1"> function returns true if the connection is successful. </span><span class="koboSpan" id="kobo.143.2">The two </span><b><span class="koboSpan" id="kobo.144.1">client.println</span></b><span class="koboSpan" id="kobo.145.1"> commands are responsible for requesting the desired page from the web server. </span><span class="koboSpan" id="kobo.145.2">The two nested </span><b><span class="koboSpan" id="kobo.146.1">while</span></b><span class="koboSpan" id="kobo.147.1"> loops then read data as long as the client is connected and data is available.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.148.1">It may look tempting to combine the two </span><b><span class="koboSpan" id="kobo.149.1">while</span></b><span class="koboSpan" id="kobo.150.1"> loops, with a condition of </span><b><span class="koboSpan" id="kobo.151.1">client.available() &amp;&amp; client.connected()</span></b><span class="koboSpan" id="kobo.152.1">, but combining them is not quite the same as treating them separately, as the data may not be available continuously from the web server because of connection speed and so on. </span><span class="koboSpan" id="kobo.152.2">The outer </span><b><span class="koboSpan" id="kobo.153.1">while</span></b><span class="koboSpan" id="kobo.154.1"> loop keeps the request alive, fetching the data.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.155.1">This approach is “blocking” (the Arduino will not do anything else until the request is complete). </span><span class="koboSpan" id="kobo.155.2">If this is not acceptable for your project, you can include code to check for other conditions inside the inner </span><b><span class="koboSpan" id="kobo.156.1">while</span></b><span class="koboSpan" id="kobo.157.1"> loop.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.158.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-9" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.159.1">Ethernet Examples</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.160.1">The following two examples serve to illustrate the use of the Ethernet library in practical settings. </span><span class="koboSpan" id="kobo.160.2">Between the two of them, the examples cover most things that you are likely to want to do with a networked Arduino.</span></span></div>
<div id="c12-10" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.161.1">Physical Web Server</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.162.1">This first example illustrates perhaps the most likely web-related use of an Arduino. </span><span class="koboSpan" id="kobo.162.2">In it, the Arduino acts as a web server. </span><span class="koboSpan" id="kobo.162.3">Browsers connecting to the Arduino web server not only see readings from the analog inputs, but visitors can also press buttons on the web page to change the digital outputs (</span><a href="#fig12-5"><span class="koboSpan" id="kobo.163.1">Figure 12-5</span></a><span class="koboSpan" id="kobo.164.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig12-5" class="image"><span><span class="koboSpan" id="kobo.165.1"><img alt="image" src="images/fig12-5.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.166.1">Figure 12-5</span></b><span class="koboSpan" id="kobo.167.1">   </span><i><span class="koboSpan" id="kobo.168.1">Physical web server interface</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.169.1">This example is actually a great way to interface an Arduino with a smartphone or tablet computer, as a device only has to have the most basic of browsers on it to be able to send requests to the Arduino. </span><span class="koboSpan" id="kobo.169.2">The sketch for this example (</span><b><span class="koboSpan" id="kobo.170.1">sketch_12_02_server</span></b><span class="koboSpan" id="kobo.171.1">) is some 172 lines long, so rather than list it in full here, I encourage you to load it in the Arduino IDE for reference as I walk you through it.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.172.1">The first part of the sketch is pretty standard for a network sketch. </span><span class="koboSpan" id="kobo.172.2">The libraries are imported, and both </span><b><span class="koboSpan" id="kobo.173.1">EthernetServer</span></b><span class="koboSpan" id="kobo.174.1"> and </span><b><span class="koboSpan" id="kobo.175.1">EthernetClient</span></b><span class="koboSpan" id="kobo.176.1"> objects are defined.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.177.1">The variables in the next section perform various roles:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.178.1"><img alt="image" src="images/p201-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.179.1">The constant </span><b><span class="koboSpan" id="kobo.180.1">numPins</span></b><span class="koboSpan" id="kobo.181.1"> defines the size of the arrays </span><b><span class="koboSpan" id="kobo.182.1">pins</span></b><span class="koboSpan" id="kobo.183.1"> and </span><b><span class="koboSpan" id="kobo.184.1">pinState</span></b><span class="koboSpan" id="kobo.185.1">. </span><span class="koboSpan" id="kobo.185.2">The </span><b><span class="koboSpan" id="kobo.186.1">pinState</span></b><span class="koboSpan" id="kobo.187.1"> array is used to remember whether the particular output pin is HIGH or LOW. </span><span class="koboSpan" id="kobo.187.2">The </span><b><span class="koboSpan" id="kobo.188.1">setup</span></b><span class="koboSpan" id="kobo.189.1"> function declares all the pins in the </span><b><span class="koboSpan" id="kobo.190.1">pins</span></b><span class="koboSpan" id="kobo.191.1"> array to be outputs. </span><span class="koboSpan" id="kobo.191.2">It also establishes the network connection in the same way as in the earlier examples. </span><span class="koboSpan" id="kobo.191.3">Finally, the </span><b><span class="koboSpan" id="kobo.192.1">line1</span></b><span class="koboSpan" id="kobo.193.1"> and </span><b><span class="koboSpan" id="kobo.194.1">buffer</span></b><span class="koboSpan" id="kobo.195.1"> character arrays hold the first line of the HTTP request and subsequent lines, respectively.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.196.1">Here is the </span><b><span class="koboSpan" id="kobo.197.1">loop</span></b><span class="koboSpan" id="kobo.198.1"> function:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.199.1"><img alt="image" src="images/p202-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.200.1"><img alt="image" src="images/p203-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.201.1">The </span><b><span class="koboSpan" id="kobo.202.1">loop</span></b><span class="koboSpan" id="kobo.203.1"> function checks to see if there are any requests from browsers waiting to be processed. </span><span class="koboSpan" id="kobo.203.2">If there is a request and there is a connection, then the </span><b><span class="koboSpan" id="kobo.204.1">readHeader</span></b><span class="koboSpan" id="kobo.205.1"> function is called. </span><span class="koboSpan" id="kobo.205.2">You’ll find the code for this toward the end of the sketch. </span><span class="koboSpan" id="kobo.205.3">The </span><b><span class="koboSpan" id="kobo.206.1">readHeader</span></b><span class="koboSpan" id="kobo.207.1"> function reads the contents of the request header into a buffer (line1) and then skips over the remaining lines of the header. </span><span class="koboSpan" id="kobo.207.2">This is required so you have access to the page name (requested by the browser) as well as any request parameters.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.208.1">Note that because the sketch has a fair amount of text to send to the Serial Monitor and network, I use the </span><b><span class="koboSpan" id="kobo.209.1">F</span></b><span class="koboSpan" id="kobo.210.1"> function to store the character arrays in flash memory (see </span><a href="ch06.html"><span class="koboSpan" id="kobo.211.1">Chapter 6</span></a><span class="koboSpan" id="kobo.212.1">).</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.213.1">Having read the header, the </span><b><span class="koboSpan" id="kobo.214.1">pageNameIs</span></b><span class="koboSpan" id="kobo.215.1"> function (again near the end of the file) is called to ensure the page being requested is the root page (</span><b><span class="koboSpan" id="kobo.216.1">/</span></b><span class="koboSpan" id="kobo.217.1">). </span><span class="koboSpan" id="kobo.217.2">If it is not the root page, then the request is ignored. </span><span class="koboSpan" id="kobo.217.3">This is important because many browsers automatically send a request to a server to find an icon for the website. </span><span class="koboSpan" id="kobo.217.4">You don’t want this request being confused with other requests to the server.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.218.1">Now you need to generate a response in the form of a header and some HTML to be returned to the browser for display. </span><span class="koboSpan" id="kobo.218.2">The </span><b><span class="koboSpan" id="kobo.219.1">sendHeader</span></b><span class="koboSpan" id="kobo.220.1"> function generates an “OK” response to indicate to the browser that the request is valid. </span><span class="koboSpan" id="kobo.220.2">The </span><b><span class="koboSpan" id="kobo.221.1">sendBody</span></b><span class="koboSpan" id="kobo.222.1"> function, shown here, is a lot more complicated:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.223.1"><img alt="image" src="images/p203-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.224.1"><img alt="image" src="images/p204-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.225.1">This function prints the basic template of the HTML page, relying on a number of helper functions to break the code down into more manageable chunks. </span><span class="koboSpan" id="kobo.225.2">The first of these is </span><b><span class="koboSpan" id="kobo.226.1">sendAnalogReadings</span></b><span class="koboSpan" id="kobo.227.1">:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.228.1"><img alt="image" src="images/p204-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.229.1">This loops over each of the analog inputs, reading the value and writing out an HTML table containing all the readings as voltages.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.230.1">You may have noticed that the </span><b><span class="koboSpan" id="kobo.231.1">sendBody</span></b><span class="koboSpan" id="kobo.232.1"> function also calls </span><b><span class="koboSpan" id="kobo.233.1">setValuesFromParams</span></b><span class="koboSpan" id="kobo.234.1"> and </span><b><span class="koboSpan" id="kobo.235.1">setPinStates</span></b><span class="koboSpan" id="kobo.236.1">. </span><span class="koboSpan" id="kobo.236.2">The first of these uses the function </span><b><span class="koboSpan" id="kobo.237.1">valueOfParam</span></b><span class="koboSpan" id="kobo.238.1"> to set the </span><b><span class="koboSpan" id="kobo.239.1">pinStates</span></b><span class="koboSpan" id="kobo.240.1"> variable containing the states of the output pins HIGH or LOW depending on the value of the request parameters that were contained in the request header:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.241.1"><img alt="image" src="images/p204-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.242.1"><img alt="image" src="images/p205-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.243.1">The </span><b><span class="koboSpan" id="kobo.244.1">valueOfParam</span></b><span class="koboSpan" id="kobo.245.1"> function expects the request parameter to be a single digit. </span><span class="koboSpan" id="kobo.245.2">You can see what these parameters look like if you run the example and browse to the page and press </span><b><span class="koboSpan" id="kobo.246.1">Update</span></b><span class="koboSpan" id="kobo.247.1">. </span><span class="koboSpan" id="kobo.247.2">The URL string will then change to include the parameters and look something like this:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.248.1"><img alt="image" src="images/p205-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.249.1">The parameters start after the </span><b><span class="koboSpan" id="kobo.250.1">?</span></b><span class="koboSpan" id="kobo.251.1"> and take the form </span><i><span class="koboSpan" id="kobo.252.1">X</span></i><span class="koboSpan" id="kobo.253.1">=</span><i><span class="koboSpan" id="kobo.254.1">Y</span></i><span class="koboSpan" id="kobo.255.1">, separated by </span><b><span class="koboSpan" id="kobo.256.1">&amp;</span></b><span class="koboSpan" id="kobo.257.1">. </span><span class="koboSpan" id="kobo.257.2">The part before the </span><b><span class="koboSpan" id="kobo.258.1">=</span></b><span class="koboSpan" id="kobo.259.1"> is the parameter name (in this case, a digit from 0 to 4) and the part after the </span><b><span class="koboSpan" id="kobo.260.1">=</span></b><span class="koboSpan" id="kobo.261.1"> is its value, which is 1 for on and 0 for off. </span><span class="koboSpan" id="kobo.261.2">To make life easy for yourself, these request parameters must be only a single character or, in this case, a single digit. </span><span class="koboSpan" id="kobo.261.3">The </span><b><span class="koboSpan" id="kobo.262.1">setPinStates</span></b><span class="koboSpan" id="kobo.263.1"> function then transfers the state of the output pins held in the </span><b><span class="koboSpan" id="kobo.264.1">pinStates</span></b><span class="koboSpan" id="kobo.265.1"> array to the actual output pins themselves.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.266.1">Let’s return to the </span><b><span class="koboSpan" id="kobo.267.1">sendBody</span></b><span class="koboSpan" id="kobo.268.1"> function for a moment. </span><span class="koboSpan" id="kobo.268.2">The next thing that you need to send is the HTML for the collection of drop-down lists for each output. </span><span class="koboSpan" id="kobo.268.3">You need the values of </span><b><span class="koboSpan" id="kobo.269.1">True</span></b><span class="koboSpan" id="kobo.270.1"> or </span><b><span class="koboSpan" id="kobo.271.1">False</span></b><span class="koboSpan" id="kobo.272.1"> in the list to be set to agree with the current state of the output. </span><span class="koboSpan" id="kobo.272.2">You accomplish this by adding the text “selected” to the value that agrees with the value for that pin in the </span><b><span class="koboSpan" id="kobo.273.1">pinStates</span></b><span class="koboSpan" id="kobo.274.1"> array.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.275.1">All the HTML generated for the output pins is contained within a form, so when a visitor presses the </span><b><span class="koboSpan" id="kobo.276.1">Update</span></b><span class="koboSpan" id="kobo.277.1"> button, a new request to this page with the appropriate request parameters to set the outputs is generated. </span><span class="koboSpan" id="kobo.277.2">At this point, let’s look at the HTML code that is generated for the page:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.278.1"><img alt="image" src="images/p205-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.279.1"><img alt="image" src="images/p206-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.280.1">You can see this using your browser’s View Source feature.</span></span></div>
<div id="c12-11" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.281.1">Using a JSON Web Service</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.282.1">To illustrate sending a web request from an Arduino to a website, I’ll use a web service that returns data about the weather in a particular location. </span><span class="koboSpan" id="kobo.282.2">It reports a short description of the weather to the Serial Monitor (</span><a href="#fig12-6"><span class="koboSpan" id="kobo.283.1">Figure 12-6</span></a><span class="koboSpan" id="kobo.284.1">). </span><span class="koboSpan" id="kobo.284.2">The sketch sends the request once during startup, but the example could easily be changed to check every hour and display the result on a 16×2 LCD display.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig12-6" class="image"><span><span class="koboSpan" id="kobo.285.1"><img alt="image" src="images/fig12-6.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.286.1">Figure 12-6</span></b><span class="koboSpan" id="kobo.287.1">   </span><i><span class="koboSpan" id="kobo.288.1">Retrieving weather information from a web service</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.289.1">The sketch for this example is quite short, just 45 lines of code (</span><b><span class="koboSpan" id="kobo.290.1">sketch_12_03_web_request</span></b><span class="koboSpan" id="kobo.291.1">). </span><span class="koboSpan" id="kobo.291.2">Most of the interesting code is in the function </span><b><span class="koboSpan" id="kobo.292.1">hitWebPage</span></b><span class="koboSpan" id="kobo.293.1">:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.294.1"><img alt="image" src="images/p207-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.295.1">The first step is to get the client to connect to the server on port 80. </span><span class="koboSpan" id="kobo.295.2">If this is successful, then the page request header is written to the server:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.296.1"><img alt="image" src="images/p207-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.297.1">The extra </span><b><span class="koboSpan" id="kobo.298.1">println</span></b><span class="koboSpan" id="kobo.299.1"> is needed to mark the end of the request header and trigger a response from the server.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.300.1">To wait for the connection, the </span><b><span class="koboSpan" id="kobo.301.1">if</span></b><span class="koboSpan" id="kobo.302.1"> statement inside the </span><b><span class="koboSpan" id="kobo.303.1">while</span></b><span class="koboSpan" id="kobo.304.1"> loop detects when data is available to be read. </span><span class="koboSpan" id="kobo.304.2">Reading the data stream directly avoids the need to capture all of the data into memory. </span><span class="koboSpan" id="kobo.304.3">The data is in JSON format:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.305.1"><img alt="image" src="images/p207-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.306.1">Returning to the </span><b><span class="koboSpan" id="kobo.307.1">hitWebPage</span></b><span class="koboSpan" id="kobo.308.1"> function, we are going to extract the section of the text from </span><b><span class="koboSpan" id="kobo.309.1">“description”</span></b><span class="koboSpan" id="kobo.310.1"> followed by a colon and then double quotation marks until the next double quotation mark using the </span><b><span class="koboSpan" id="kobo.311.1">findUntil</span></b><span class="koboSpan" id="kobo.312.1"> and </span><b><span class="koboSpan" id="kobo.313.1">readStringUntil</span></b><span class="koboSpan" id="kobo.314.1"> functions.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.315.1">The </span><b><span class="koboSpan" id="kobo.316.1">findUntil</span></b><span class="koboSpan" id="kobo.317.1"> function just ignores everything from the server until the matching string is found. </span><span class="koboSpan" id="kobo.317.2">The </span><b><span class="koboSpan" id="kobo.318.1">readStringUntil</span></b><span class="koboSpan" id="kobo.319.1"> function then reads all the subsequent text until the double quote character.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.320.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-12" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.321.1">The WiFi Library</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.322.1">As you might expect, the WiFi library is quite similar to the Ethernet library. </span><span class="koboSpan" id="kobo.322.2">If you substitute </span><b><span class="koboSpan" id="kobo.323.1">WiFi</span></b><span class="koboSpan" id="kobo.324.1"> for </span><b><span class="koboSpan" id="kobo.325.1">Ethernet</span></b><span class="koboSpan" id="kobo.326.1">, </span><b><span class="koboSpan" id="kobo.327.1">WiFiServer</span></b><span class="koboSpan" id="kobo.328.1"> for </span><b><span class="koboSpan" id="kobo.329.1">EthernetServer</span></b><span class="koboSpan" id="kobo.330.1">, and </span><b><span class="koboSpan" id="kobo.331.1">WiFiClient</span></b><span class="koboSpan" id="kobo.332.1"> for </span><b><span class="koboSpan" id="kobo.333.1">EthernetClient</span></b><span class="koboSpan" id="kobo.334.1">, then everything else in your sketch can pretty much stay the same.</span></span></div>
<div id="c12-13" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.335.1">Making a Connection</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.336.1">The main differences between the WiFi and Ethernet libraries are in how a connection is established.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.337.1">First, you need to import the WiFi library:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.338.1"><img alt="image" src="images/p208-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.339.1">To establish a connection, use the </span><b><span class="koboSpan" id="kobo.340.1">WiFi.begin</span></b><span class="koboSpan" id="kobo.341.1"> command, supplying it with the name of your wireless network and your password.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.342.1"><img alt="image" src="images/p208-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.343.1">The WiFi example that follows in “WiFi Example” illustrates the other differences that you need to be aware of.</span></span></div>
<div id="c12-14" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.344.1">WiFi Specific Functions</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.345.1">The WiFi library has some extra WiFi-specific functions that you can use. </span><span class="koboSpan" id="kobo.345.2">These functions are summarized in </span><a href="#tab12-1"><span class="koboSpan" id="kobo.346.1">Table 12-1</span></a><span class="koboSpan" id="kobo.347.1">.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="tab12-1" class="imagex"><span><span class="koboSpan" id="kobo.348.1"><img alt="image" src="images/tab12-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.349.1">Table 12-1</span></b><span class="koboSpan" id="kobo.350.1">   </span><i><span class="koboSpan" id="kobo.351.1">WiFi Specific Features</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.352.1">You can find full documentation for the WiFi library here: </span><a href="http://arduino.cc/en/Reference/WiFi"><span class="koboSpan" id="kobo.353.1">http://arduino.cc/en/Reference/WiFi</span></a><span class="koboSpan" id="kobo.354.1">.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.355.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-15" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.356.1">WiFi Example</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.357.1">For the example, I modified </span><b><span class="koboSpan" id="kobo.358.1">sketch_12_02_server</span></b><span class="koboSpan" id="kobo.359.1"> to work with a WiFi Shield. </span><span class="koboSpan" id="kobo.359.2">You can find the code in </span><b><span class="koboSpan" id="kobo.360.1">sketch_12_04_server_wifi</span></b><span class="koboSpan" id="kobo.361.1">. </span><span class="koboSpan" id="kobo.361.2">Rather than repeat the whole example, I will just highlight the changes from the original version.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.362.1">First, to make the connection to a wireless access point, you need to specify the name of the wireless network and its password:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.363.1"><img alt="image" src="images/p209-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.364.1">You also need to change the names of the classes for the server and client from </span><b><span class="koboSpan" id="kobo.365.1">EthernetServer</span></b><span class="koboSpan" id="kobo.366.1"> and </span><b><span class="koboSpan" id="kobo.367.1">EthernetClient</span></b><span class="koboSpan" id="kobo.368.1"> to </span><b><span class="koboSpan" id="kobo.369.1">WiFiServer</span></b><span class="koboSpan" id="kobo.370.1"> and </span><b><span class="koboSpan" id="kobo.371.1">WiFiClient</span></b><span class="koboSpan" id="kobo.372.1">:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.373.1"><img alt="image" src="images/p209-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.374.1">You still need to specify port 80 when defining the server.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.375.1">The next difference between the two shields is at the point where the connection starts. </span><span class="koboSpan" id="kobo.375.2">In this case, you must use</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.376.1"><img alt="image" src="images/p209-03.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.377.1">The remainder of the code is almost exactly the same as the Ethernet code. </span><span class="koboSpan" id="kobo.377.2">You will find a </span><b><span class="koboSpan" id="kobo.378.1">delay(1)</span></b><span class="koboSpan" id="kobo.379.1"> command in </span><b><span class="koboSpan" id="kobo.380.1">loop</span></b><span class="koboSpan" id="kobo.381.1"> before the client is stopped, which gives the client time to finish reading before the communication is closed. </span><span class="koboSpan" id="kobo.381.2">You don’t need this in the Ethernet version. </span><span class="koboSpan" id="kobo.381.3">You’ll also notice that I combined some of the </span><b><span class="koboSpan" id="kobo.382.1">client.print</span></b><span class="koboSpan" id="kobo.383.1"> calls into fewer calls of bigger strings. </span><span class="koboSpan" id="kobo.383.2">This speeds up the communication as the WiFi Shield deals with sending small strings quite inefficiently. </span><span class="koboSpan" id="kobo.383.3">However, be aware that the strings in an individual </span><b><span class="koboSpan" id="kobo.384.1">client.print</span></b><span class="koboSpan" id="kobo.385.1"> or </span><b><span class="koboSpan" id="kobo.386.1">client.println</span></b><span class="koboSpan" id="kobo.387.1"> cannot be longer than 90 bytes or they will not be sent.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.388.1">The WiFi version of this program is considerably slower than the Ethernet version, taking up to 45 seconds to load. </span><span class="koboSpan" id="kobo.388.2">The firmware on the WiFi Shield can be updated, and if in the future the Arduino team improves the efficiency of the WiFi Shield, then it may be worth updating the firmware. </span><span class="koboSpan" id="kobo.388.3">Look for instructions for this on the WiFi Shield web page: </span><a href="http://arduino.cc/en/Main/ArduinoWiFiShield"><span class="koboSpan" id="kobo.389.1">http://arduino.cc/en/Main/ArduinoWiFiShield</span></a><span class="koboSpan" id="kobo.390.1">.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.391.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c12-16" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.392.1">Summary</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.393.1">In this chapter, you looked at a variety of ways to connect your Arduino to a network and then make it do something, using both Ethernet and Wi-Fi Shields. </span><span class="koboSpan" id="kobo.393.2">You have also learned how to use an Arduino as both a web server and a web client.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.394.1">In the next chapter, you’ll learn about Digital Signal Processing (DSP) with the Arduino.</span></span></div>
</div></div></body>
</html>