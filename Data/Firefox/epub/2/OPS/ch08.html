<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Programming Arduino™ Next Steps: Going Further with Sketches</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta>
<link href="stylesheet.css" type="text/css" rel="stylesheet"></link>

<!-- kobo-style -->
<link type="text/css" rel="stylesheet" href="css/kobo.css"></link>
<script type="text/javascript" src="js/kobo.js"></script>
<style type="text/css" id="kobostylehacks">div#book-inner p, div#book-inner div { font-size: 1.0em; } a { color: black; } a:link, a:visited, a:hover, a:active { color: blue; } div#book-inner * { margin-top: 0 !important; margin-bottom: 0 !important;}</style>
</head>
<body><div id="book-columns"><div id="book-inner">
<div class="chapnum" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.1.1">8</span></span></div>
<div class="chaptitle" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.2.1">Interfacing with 1-Wire Devices</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="big"><span class="koboSpan" id="kobo.3.1">1-Wire is</span></span><span class="koboSpan" id="kobo.4.1"> a bus standard designed to serve a similar purpose to the I2C bus (see </span><a href="ch07.html"><span class="koboSpan" id="kobo.5.1">Chapter 7</span></a><span class="koboSpan" id="kobo.6.1">)—that is, to allow microcontrollers to communicate with peripheral ICs with a minimal number of data lines. </span><span class="koboSpan" id="kobo.6.2">The 1-Wire standard created by Dallas Semiconductor has taken this to its logical extreme by reducing the data lines used to just one. </span><span class="koboSpan" id="kobo.6.3">The bus is slower than I2C, and it has the interesting feature of </span><i><span class="koboSpan" id="kobo.7.1">parasitic power</span></i><span class="koboSpan" id="kobo.8.1">, which allows remote devices to be connected to a microcontroller with just two wires, GND (ground), and combined power and data wire.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.9.1">The 1-Wire bus standard has a much smaller range of potential devices than I2C, most manufactured by Dallas Semiconductor or Maxim. </span><span class="koboSpan" id="kobo.9.2">They include printer cartridge identity devices, EEPROM flash memory, and analog-to-digital converters (ADCs). </span><span class="koboSpan" id="kobo.9.3">However, the most commonly used 1-Wire device for hobbyists is the Dallas Semiconductor DS18B20 temperature sensor.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.10.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c8-1" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.11.1">1-Wire Hardware</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><a href="#fig8-1"><span class="koboSpan" id="kobo.12.1">Figure 8-1</span></a><span class="koboSpan" id="kobo.13.1"> shows how you can connect a DS18B20 to an Arduino using just two connections and the DS18B20’s parasitic power mode.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig8-1" class="image"><span><span class="koboSpan" id="kobo.14.1"><img alt="image" src="images/fig8-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.15.1">Figure 8-1</span></b><span class="koboSpan" id="kobo.16.1">   </span><i><span class="koboSpan" id="kobo.17.1">Connecting a 1-Wire device to an Arduino</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.18.1">1-Wire is a bus, rather than a point-to-point connection, and you can chain together up to 255 devices using the arrangement shown in </span><a href="#fig8-1"><span class="koboSpan" id="kobo.19.1">Figure 8-1</span></a><span class="koboSpan" id="kobo.20.1">. </span><span class="koboSpan" id="kobo.20.2">If you wish to use the device in “normal” power mode, then you can omit the 4.7 kΩ resistor and connect Vdd on the DS18B20 directly to 5V from the Arduino instead of to GND.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.21.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c8-2" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.22.1">The 1-Wire Protocol</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.23.1">Just as with I2C, 1-Wire uses the master and slave concept for devices. </span><span class="koboSpan" id="kobo.23.2">The microcontroller is the master and the peripherals are the slaves. </span><span class="koboSpan" id="kobo.23.3">Each slave device is given a unique ID known as its “address” during manufacturing, so it can be identified on the bus when there are multiple slaves. </span><span class="koboSpan" id="kobo.23.4">This address is 64 bits in length, allowing for roughly 1.8×10</span><small><sup><span class="koboSpan" id="kobo.24.1">19</span></sup></small><span class="koboSpan" id="kobo.25.1"> different IDs.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.26.1">The protocol is similar to I2C in that the bus line is switched from being an input to being an output by the master to allow two-way communication. </span><span class="koboSpan" id="kobo.26.2">However, rather than have separate clock and data signals, 1-Wire has just a single data line and uses long and short pulses to signify 1s and 0s. </span><span class="koboSpan" id="kobo.26.3">A pulse of 60 μS signifies a 0 and 15 μS indicates a 1.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.27.1">The data line is normally HIGH, but when the microcontroller (master) needs to send a command to the device, it sends a special “reset” LOW pulse of at least 480 microseconds. </span><span class="koboSpan" id="kobo.27.2">The stream of 1 and 0 pulses then follow this.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.28.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c8-3" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.29.1">The OneWire Library</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.30.1">The use of 1-Wire is greatly simplified by the OneWire library, which you can download from </span><a href="http://playground.arduino.cc/Learning/OneWire"><span class="koboSpan" id="kobo.31.1">http://playground.arduino.cc/Learning/OneWire</span></a><span class="koboSpan" id="kobo.32.1">.</span></span></div>
<div id="c8-4" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.33.1">Initializing 1-Wire</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.34.1">The first step in using an Arduino as the master on a 1-Wire bus is to import the OneWire library using this command:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.35.1"><img alt="image" src="images/p143-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.36.1">The next step is to create an instance of OneWire and specify the Arduino pin to be used for the 1-Wire data bus. </span><span class="koboSpan" id="kobo.36.2">You can combine these into a single command, and you can use any Arduino pin for the bus; simply supply the pin number as the parameter:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.37.1"><img alt="image" src="images/p143-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.38.1">In the example, the bus will be initialized on pin D10 of the Arduino.</span></span></div>
<div id="c8-5" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.39.1">Scanning the Bus</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.40.1">Because each slave device on the bus is allocated a unique ID during manufacturing, you need a way to find the devices on the network. </span><span class="koboSpan" id="kobo.40.2">It would be unwise to hard-code device addresses into the Arduino sketch because if you were to replace one of the slave devices, the new device would have a different address than the old one and you wouldn’t be able to use it. </span><span class="koboSpan" id="kobo.40.3">So the master (Arduino) can essentially produce a list of the devices on the bus. </span><span class="koboSpan" id="kobo.40.4">What is more, the first 8 bits of the address indicate the “family” of device, so you can tell if the device is, say, a DS18B20 or some other type of device.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><a href="#tab8-1"><span class="koboSpan" id="kobo.41.1">Table 8-1</span></a><span class="koboSpan" id="kobo.42.1"> lists some of the most common family codes for 1-Wire. </span><span class="koboSpan" id="kobo.42.2">You can find a more complete list here: </span><a href="http://owfs.sourceforge.net/family.html"><span class="koboSpan" id="kobo.43.1">http://owfs.sourceforge.net/family.html</span></a><span class="koboSpan" id="kobo.44.1">.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="tab8-1" class="imagex"><span><span class="koboSpan" id="kobo.45.1"><img alt="image" src="images/tab8-1.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.46.1">Table 8-1</span></b><span class="koboSpan" id="kobo.47.1">   </span><i><span class="koboSpan" id="kobo.48.1">Family Codes for 1-Wire Addresses</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.49.1">The OneWire library has a </span><b><span class="koboSpan" id="kobo.50.1">search</span></b><span class="koboSpan" id="kobo.51.1"> function that you can use to find all the slave devices on the bus. </span><span class="koboSpan" id="kobo.51.2">The following example code lists the addresses of all the devices on the bus to the Serial Monitor:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.52.1"><img alt="image" src="images/p144-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><a href="#fig8-2"><span class="koboSpan" id="kobo.53.1">Figure 8-2</span></a><span class="koboSpan" id="kobo.54.1"> shows the result of running this sketch with two DS18B20 temperature sensors attached to an Arduino. </span><span class="koboSpan" id="kobo.54.2">Note that for both devices, the “family” code is contained in the first byte and is 28 (hexadecimal) in both cases.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig8-2" class="image"><span><span class="koboSpan" id="kobo.55.1"><img alt="image" src="images/fig8-2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.56.1">Figure 8-2</span></b><span class="koboSpan" id="kobo.57.1">   </span><i><span class="koboSpan" id="kobo.58.1">Listing 1-Wire slave devices</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.59.1">The </span><b><span class="koboSpan" id="kobo.60.1">search</span></b><span class="koboSpan" id="kobo.61.1"> function requires an array of 8 bytes in which to put the next address that it finds. </span><span class="koboSpan" id="kobo.61.2">If no more devices are to be found, it will return 0. </span><span class="koboSpan" id="kobo.61.3">This allows the </span><b><span class="koboSpan" id="kobo.62.1">while</span></b><span class="koboSpan" id="kobo.63.1"> loop in the previous example to keep iterating until all the addresses have been displayed. </span><span class="koboSpan" id="kobo.63.2">The last byte of the address is actually a cyclic redundancy check (CRC) that ensures the integrity of the address. </span><span class="koboSpan" id="kobo.63.3">The OneWire library includes a CRC checking function.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.64.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c8-6" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.65.1">Using the DS18B20</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.66.1">The following example illustrates the use of OneWire with the DS18B20 temperature sensor. </span><a href="#fig8-3"><span class="koboSpan" id="kobo.67.1">Figure 8-3</span></a><span class="koboSpan" id="kobo.68.1"> shows a DS18B20 chip connected to an Arduino. </span><span class="koboSpan" id="kobo.68.2">Note how the chip itself is just a three pin transistor-like chip.</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig8-3" class="image"><span><span class="koboSpan" id="kobo.69.1"><img alt="image" src="images/fig8-3.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.70.1">Figure 8-3</span></b><span class="koboSpan" id="kobo.71.1">   </span><i><span class="koboSpan" id="kobo.72.1">A DS18B20s connected to an Arduino</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.73.1">The Dallas Semiconductor temperature sensor has its own library that makes requesting the temperature and decoding the result easier. </span><span class="koboSpan" id="kobo.73.2">The DallasTemperature library can be downloaded from here: </span><a href="https://github.com/milesburton/Arduino-Temperature-Control-Library"><span class="koboSpan" id="kobo.74.1">https://github.com/milesburton/Arduino-Temperature-Control-Library</span></a><span class="koboSpan" id="kobo.75.1">.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.76.1"><img alt="image" src="images/p145-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.77.1"><img alt="image" src="images/p146-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.78.1">This example displays the temperature in Celsius from a single temperature sensor in the Serial Monitor window (</span><a href="#fig8-4"><span class="koboSpan" id="kobo.79.1">Figure 8-4</span></a><span class="koboSpan" id="kobo.80.1">).</span></span></div>
<div class="break" xmlns="http://www.w3.org/1999/xhtml">
<div id="fig8-4" class="image"><span><span class="koboSpan" id="kobo.81.1"><img alt="image" src="images/fig8-4.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="caption"><span><b><span class="koboSpan" id="kobo.82.1">Figure 8-4</span></b><span class="koboSpan" id="kobo.83.1">   </span><i><span class="koboSpan" id="kobo.84.1">Displaying the temperature using a DS18B20</span></i></span></div>
</div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.85.1">This example uses just one temperature sensor, but you can easily extend it to use multiple sensors. </span><span class="koboSpan" id="kobo.85.2">The DallasTemperature library wraps the OneWire address discovery process in the </span><b><span class="koboSpan" id="kobo.86.1">getAddress</span></b><span class="koboSpan" id="kobo.87.1"> function, the second parameter of which is the index position of the sensor. </span><span class="koboSpan" id="kobo.87.2">To add a second sensor, you need to add a new variable for its address and then set that address using </span><b><span class="koboSpan" id="kobo.88.1">getAddress</span></b><span class="koboSpan" id="kobo.89.1">. </span><span class="koboSpan" id="kobo.89.2">You can download an example of using two sensors from the book’s website as </span><b><span class="koboSpan" id="kobo.90.1">sketch_08_03_OneWire_DS18B20_2</span></b><span class="koboSpan" id="kobo.91.1">.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.92.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c8-7" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.93.1">Summary</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.94.1">In this chapter, you learned a little about the 1-Wire bus and how to use it with the popular DS18B20 temperature sensor.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.95.1">In the next chapter, we look at yet another kind of serial data interface called SPI.</span></span></div>
</div></div></body>
</html>