<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Programming Arduino™ Next Steps: Going Further with Sketches</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta>
<link href="stylesheet.css" type="text/css" rel="stylesheet"></link>

<!-- kobo-style -->
<link type="text/css" rel="stylesheet" href="css/kobo.css"></link>
<script type="text/javascript" src="js/kobo.js"></script>
<style type="text/css" id="kobostylehacks">div#book-inner p, div#book-inner div { font-size: 1.0em; } a { color: black; } a:link, a:visited, a:hover, a:active { color: blue; } div#book-inner * { margin-top: 0 !important; margin-bottom: 0 !important;}</style>
</head>
<body><div id="book-columns"><div id="book-inner">
<div class="chapnum" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.1.1">14</span></span></div>
<div class="chaptitle" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.2.1">Managing with One Process</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="big"><span class="koboSpan" id="kobo.3.1">Programmers coming</span></span><span class="koboSpan" id="kobo.4.1"> to Arduino from a background in programming large systems often cite the lack of multithreading and concurrency in Arduino as a deficiency. </span><span class="koboSpan" id="kobo.4.2">In this chapter, I’ll try to set the record straight and show you how to embrace the single-thread model of embedded systems.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.5.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c14-1" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.6.1">Making the Transition from Big Programming</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.7.1">Arduino has attracted many enthusiasts, including me, who have spent years in the software industry and are used to teams of dozens of people contributing to a huge software effort, with all the related problems of managing the ensuing complexity. </span><span class="koboSpan" id="kobo.7.2">For us, the ability to write a few lines of code and have something interesting and physical happen almost immediately, without large amounts of engineering, is the perfect antidote to big software.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.8.1">It does, however, mean that we often look for things in Arduino that we are used to seeing in our day jobs. </span><span class="koboSpan" id="kobo.8.2">When moving from the big development world to the miniature world of Arduino, one of the first adjustments we need to make is to the very simplicity of writing for Arduino. </span><span class="koboSpan" id="kobo.8.3">To develop a large system without the benefit of Test Driven Development, version control, and some kind of Agile process to follow is reckless. </span><span class="koboSpan" id="kobo.8.4">On the other hand, a large Arduino project may be only 200 lines of code written by one person. </span><span class="koboSpan" id="kobo.8.5">If that person is an experienced software developer, he or she can simply keep the details in mind without needing any of the usual accoutrements of development.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.9.1">So stop fretting about version control, design patterns, writing unit tests, and having a refactoring IDE and just embrace the joyous simplicity of Arduino.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.10.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c14-2" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.11.1">Why You Don’t Need Threads</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.12.1">If you are old enough to have programmed home computers in BASIC, then you remember that “doing one thing at a time” is simply how computers operate. </span><span class="koboSpan" id="kobo.12.2">In BASIC, if a game required a number of sprites to be moved apparently simultaneously, then you had to be smart and include a main loop that moved each sprite a little bit.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.13.1">This mindset is a good one to have for Arduino programming. </span><span class="koboSpan" id="kobo.13.2">Rather than multiple threads each being responsible for one of the sprites, a single execution thread does a little bit of everything in turn, without “blocking” on any one thing.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.14.1">Aside from multicore computers, essentially a computer only genuinely does one thing at once. </span><span class="koboSpan" id="kobo.14.2">The rest of the time, the operating system switches the processor’s attention among the numerous processes running on the computer. </span><span class="koboSpan" id="kobo.14.3">On the Arduino, with a limited need to do more than one thing at a time, you can code it yourself, as there is no operating system.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.15.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c14-3" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.16.1">Setup and Loop</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.17.1">It is no accident that the two functions you must write for any sketch are </span><b><span class="koboSpan" id="kobo.18.1">setup</span></b><span class="koboSpan" id="kobo.19.1"> and </span><b><span class="koboSpan" id="kobo.20.1">loop</span></b><span class="koboSpan" id="kobo.21.1">. </span><span class="koboSpan" id="kobo.21.2">The fact that </span><b><span class="koboSpan" id="kobo.22.1">loop</span></b><span class="koboSpan" id="kobo.23.1"> repeats over and over again, indicates why you should not really allow loop to block. </span><span class="koboSpan" id="kobo.23.2">Your code should wiz through loop and around again before you know it.</span></span></div>
<div id="c14-4" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.24.1">Sense Then Act</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.25.1">Most Arduino projects contain an element of needing to control something. </span><span class="koboSpan" id="kobo.25.2">Therefore, the contents of a loop often:</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.26.1">•  Check if buttons are pressed or a sensor threshold has been exceeded.</span></span></div>
<div class="hangbull" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.27.1">•  Perform a relevant action.</span></span></div>
<div class="noindent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.28.1">A simple example of this would be a push switch that, when pressed, toggles LED flashing on and off.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.29.1">The following example illustrates this. </span><span class="koboSpan" id="kobo.29.2">As you shall see later, however, the limitations imposed by having to wait while the LED flashes are sometimes not acceptable.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.30.1"><img alt="image" src="images/p233-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.31.1">The problem with this code is that you can only check that the button has been pressed once the blinking has finished. </span><span class="koboSpan" id="kobo.31.2">If a button is pressed while the blinking is in progress, it won’t register. </span><span class="koboSpan" id="kobo.31.3">This may not be important to the operation of the sketch, but if it is important to register every button press, then you need to make sure the loop does not have any delays in it. </span><span class="koboSpan" id="kobo.31.4">In fact, once the flashing is triggered, the Arduino spends most of its time blinking and there is only a tiny window in which the button press can be registered.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.32.1">The example in the next section solves this problem.</span></span></div>
<div id="c14-5" class="head1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.33.1">Pause Without Blocking</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.34.1">You can rewrite the previous sketch to avoid using </span><b><span class="koboSpan" id="kobo.35.1">delay</span></b><span class="koboSpan" id="kobo.36.1">:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.37.1"><img alt="image" src="images/p234-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.38.1"><img alt="image" src="images/p235-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.39.1">In this sketch, I have added two new variables: </span><b><span class="koboSpan" id="kobo.40.1">lastChangeTime</span></b><span class="koboSpan" id="kobo.41.1"> and </span><b><span class="koboSpan" id="kobo.42.1">ledState</span></b><span class="koboSpan" id="kobo.43.1">. </span><span class="koboSpan" id="kobo.43.2">The </span><b><span class="koboSpan" id="kobo.44.1">lastChangeTime</span></b><span class="koboSpan" id="kobo.45.1"> variable records the last time the LED was toggled between on and off, and the </span><b><span class="koboSpan" id="kobo.46.1">ledState</span></b><span class="koboSpan" id="kobo.47.1"> variable contains that on/off state, so when it needs to be toggled, you know what the LED’s current state is.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.48.1">The loop now contains no delays. </span><span class="koboSpan" id="kobo.48.2">The first part of the loop checks for a button press, and if a button is pressed, it toggles the flashing state. </span><span class="koboSpan" id="kobo.48.3">The extra </span><b><span class="koboSpan" id="kobo.49.1">if</span></b><span class="koboSpan" id="kobo.50.1"> statement, shown next, is simply a nice refinement that turns the LED off if the button press has caused flashing to be turned off. </span><span class="koboSpan" id="kobo.50.2">Otherwise, the LED might be left on, even though flashing has been canceled.</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.51.1"><img alt="image" src="images/p235-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.52.1">The second part of the loop finds the current </span><b><span class="koboSpan" id="kobo.53.1">millis()</span></b><span class="koboSpan" id="kobo.54.1"> count and then compares this with the value in </span><b><span class="koboSpan" id="kobo.55.1">lastChangeTime</span></b><span class="koboSpan" id="kobo.56.1"> with </span><b><span class="koboSpan" id="kobo.57.1">period</span></b><span class="koboSpan" id="kobo.58.1"> added to it. </span><span class="koboSpan" id="kobo.58.2">This means that the code inside the </span><b><span class="koboSpan" id="kobo.59.1">if</span></b><span class="koboSpan" id="kobo.60.1"> will only be run if more than </span><b><span class="koboSpan" id="kobo.61.1">period</span></b><span class="koboSpan" id="kobo.62.1"> milliseconds has elapsed.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.63.1">The </span><b><span class="koboSpan" id="kobo.64.1">ledState</span></b><span class="koboSpan" id="kobo.65.1"> variable is then toggled and the digital output set accordingly. </span><span class="koboSpan" id="kobo.65.2">The value in </span><b><span class="koboSpan" id="kobo.66.1">now</span></b><span class="koboSpan" id="kobo.67.1"> is then copied to </span><b><span class="koboSpan" id="kobo.68.1">lastChangeTime</span></b><span class="koboSpan" id="kobo.69.1"> so the code can wait for the next </span><b><span class="koboSpan" id="kobo.70.1">period</span></b><span class="koboSpan" id="kobo.71.1"> to elapse before being activated again.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.72.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c14-6" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.73.1">The Timer Library</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.74.1">The “Pause Without Blocking” approach of the previous section has been generalized into a library that allows you to schedule repeating events using </span><b><span class="koboSpan" id="kobo.75.1">millis</span></b><span class="koboSpan" id="kobo.76.1">. </span><span class="koboSpan" id="kobo.76.2">Despite its name, the library has nothing to do with the hardware timers on the device and will, therefore, work just fine on most Arduino boards.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.77.1">You can download the library from </span><a href="http://playground.arduino.cc//Code/Timer"><span class="koboSpan" id="kobo.78.1">http://playground.arduino.cc//Code/Timer</span></a><span class="koboSpan" id="kobo.79.1">.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.80.1">Using this library simplifies the code, as you can see here:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.81.1"><img alt="image" src="images/p236-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.82.1">To use this library, you define a timer, in this case called </span><b><span class="koboSpan" id="kobo.83.1">t</span></b><span class="koboSpan" id="kobo.84.1">, and then within your </span><b><span class="koboSpan" id="kobo.85.1">setup</span></b><span class="koboSpan" id="kobo.86.1"> function you specify a function that calls periodically using:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.87.1"><img alt="image" src="images/p237-01.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.88.1">You then place the following line in your </span><b><span class="koboSpan" id="kobo.89.1">loop</span></b><span class="koboSpan" id="kobo.90.1"> function:</span></span></div>
<div class="image3" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.91.1"><img alt="image" src="images/p237-02.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div class="noindent1" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.92.1">Every time the </span><b><span class="koboSpan" id="kobo.93.1">update</span></b><span class="koboSpan" id="kobo.94.1"> function is called, </span><b><span class="koboSpan" id="kobo.95.1">millis</span></b><span class="koboSpan" id="kobo.96.1"> checks when any of the timed events need to be actioned, and if they do, it calls the linked function (in this case </span><b><span class="koboSpan" id="kobo.97.1">flashIfRequired</span></b><span class="koboSpan" id="kobo.98.1">).</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.99.1">The Timer library also has a number of other utility functions; for more information on the library, see the link at the beginning of this section.</span></span></div>
<div class="image2" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.100.1"><img width="100%" alt="image" src="images/line2.jpg" xmlns="http://www.w3.org/1999/xhtml"></img></span></span></div>
<div id="c14-7" class="head" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.101.1">Summary</span></span></div>
<div class="noindent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.102.1">In this chapter, you learned how to allow multiple things to appear to happen at the same time on an Arduino, without using multiple threads. </span><span class="koboSpan" id="kobo.102.2">This is simply a matter of adjusting your mindset to the constraints imposed by your favorite little microcontroller board.</span></span></div>
<div class="indent" xmlns="http://www.w3.org/1999/xhtml"><span><span class="koboSpan" id="kobo.103.1">In the final chapter of this book, you will learn how to share your code creations with the Arduino community by creating and publishing Arduino libraries.</span></span></div>
</div></div></body>
</html>